import { Overlay, OverlayPositionBuilder, ScrollStrategyOptions } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { ChangeDetectorRef, ElementRef, inject, Injectable, Injector } from '@angular/core';
import { takeUntil } from 'rxjs';
import { LuMultiSelectPanelComponent } from '../panel';
import { MULTI_SELECT_PANEL_DATA } from '../select.model';
import { LuMultiSelectPanelRef } from './panel.model';
import * as i0 from "@angular/core";
class MultiSelectPanelRef extends LuMultiSelectPanelRef {
    constructor(overlayRef, parentInjector, panelData, defaultPositionStrategy, expandedPositionStrategy) {
        super();
        this.overlayRef = overlayRef;
        this.defaultPositionStrategy = defaultPositionStrategy;
        this.expandedPositionStrategy = expandedPositionStrategy;
        const injector = Injector.create({
            providers: [
                { provide: LuMultiSelectPanelRef, useValue: this },
                { provide: MULTI_SELECT_PANEL_DATA, useValue: panelData },
            ],
            parent: parentInjector,
        });
        this.portalRef = new ComponentPortal(LuMultiSelectPanelComponent, undefined, injector);
        this.panelRef = overlayRef.attach(this.portalRef);
        this.instance = this.panelRef.instance;
        overlayRef
            .backdropClick()
            .pipe(takeUntil(this.closed))
            .subscribe(() => this.close());
    }
    emitValue(value) {
        this.valueChanged.emit(value);
    }
    updateSelectedOptions(selectedOptions) {
        this.instance.selectedOptions = selectedOptions;
        // Run change detection on the panel component
        this.panelRef.injector.get(ChangeDetectorRef).markForCheck();
    }
    useExpandedPosition() {
        this.overlayRef.updatePositionStrategy(this.expandedPositionStrategy);
    }
    useDefaultPosition() {
        this.overlayRef.updatePositionStrategy(this.defaultPositionStrategy);
    }
    close() {
        super.close();
        this.panelRef.destroy();
        this.overlayRef.detach();
    }
}
class LuMultiSelectPanelRefFactory {
    constructor() {
        this.overlay = inject(Overlay);
        this.elementRef = inject(ElementRef);
        this.positionBuilder = inject(OverlayPositionBuilder);
        this.scrollStrategies = inject(ScrollStrategyOptions);
        this.parentInjector = inject(Injector);
    }
    buildPanelRef(panelData, defaultOverlayConfigOverride = {}, expandedPositionStrategy) {
        const defaultOverlayConfig = this.buildDefaultOverlayConfig(defaultOverlayConfigOverride);
        expandedPositionStrategy ??= this.buildExpandedPositionStrategy();
        const overlayRef = this.overlay.create(defaultOverlayConfig);
        overlayRef.hostElement.style.transitionProperty = 'height';
        overlayRef.hostElement.style.transitionDuration = 'var(--commons-animations-durations-standard)';
        return new MultiSelectPanelRef(overlayRef, this.parentInjector, panelData, defaultOverlayConfig.positionStrategy, expandedPositionStrategy);
    }
    buildDefaultOverlayConfig(overlayConfigOverride = {}) {
        const overlayConfig = { ...overlayConfigOverride };
        const config = { overlapInput: false, offsetY: 2 };
        overlayConfig.positionStrategy = this.positionBuilder
            .flexibleConnectedTo(this.elementRef)
            .withViewportMargin(10)
            .withPositions([
            this.buildPosition('bottom', 'right', config),
            this.buildPosition('bottom', 'left', config),
            this.buildPosition('top', 'right', config),
            this.buildPosition('top', 'left', config),
        ]);
        overlayConfig.scrollStrategy = this.scrollStrategies.reposition();
        overlayConfig.minWidth = this.elementRef.nativeElement.clientWidth;
        overlayConfig.maxWidth = '100vw';
        return overlayConfig;
    }
    buildExpandedPositionStrategy() {
        const config = { overlapInput: true, offsetX: -4, offsetY: -4 };
        return this.positionBuilder
            .flexibleConnectedTo(this.elementRef)
            .withViewportMargin(10)
            .withPositions([
            this.buildPosition('top', 'right', config),
            this.buildPosition('top', 'left', config),
            this.buildPosition('bottom', 'right', config),
            this.buildPosition('bottom', 'left', config),
        ]);
    }
    buildPosition(yDirection, xDirection, config) {
        const originX = xDirection === 'right' ? 'start' : 'end';
        const overlayX = originX;
        const oppositeYDirection = yDirection === 'top' ? 'bottom' : 'top';
        const { originY, overlayY } = config.overlapInput
            ? {
                originY: oppositeYDirection,
                overlayY: oppositeYDirection,
            }
            : { originY: yDirection, overlayY: oppositeYDirection };
        return {
            originX,
            originY,
            overlayX,
            overlayY,
            ...(config.offsetX ? { offsetX: xDirection === 'right' ? config.offsetX : -config.offsetX } : {}),
            ...(config.offsetY ? { offsetY: yDirection === 'bottom' ? config.offsetY : -config.offsetY } : {}),
        };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuMultiSelectPanelRefFactory, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuMultiSelectPanelRefFactory }); }
}
export { LuMultiSelectPanelRefFactory };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuMultiSelectPanelRefFactory, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZWwtcmVmLmZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9uZy9tdWx0aS1zZWxlY3QvaW5wdXQvcGFuZWwtcmVmLmZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFxQixPQUFPLEVBQWlCLHNCQUFzQixFQUFnQyxxQkFBcUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzlKLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsaUJBQWlCLEVBQWdCLFVBQVUsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN2RCxPQUFPLEVBQTJCLHVCQUF1QixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZUFBZSxDQUFDOztBQUV0RCxNQUFNLG1CQUF1QixTQUFRLHFCQUF3QjtJQUs1RCxZQUNTLFVBQXNCLEVBQzlCLGNBQXdCLEVBQ3hCLFNBQXFDLEVBQzNCLHVCQUF5QyxFQUN6Qyx3QkFBMEM7UUFFcEQsS0FBSyxFQUFFLENBQUM7UUFOQSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBR3BCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBa0I7UUFDekMsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUFrQjtRQUlwRCxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ2hDLFNBQVMsRUFBRTtnQkFDVixFQUFFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO2dCQUNsRCxFQUFFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxRQUFRLEVBQUUsU0FBUyxF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QUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztTQUNsRyxDQUFDO0lBQ0gsQ0FBQzs4R0FoRlcsNEJBQTRCO2tIQUE1Qiw0QkFBNEI7O1NBQTVCLDRCQUE0QjsyRkFBNUIsNEJBQTRCO2tCQUR4QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29ubmVjdGVkUG9zaXRpb24sIE92ZXJsYXksIE92ZXJsYXlDb25maWcsIE92ZXJsYXlQb3NpdGlvbkJ1aWxkZXIsIE92ZXJsYXlSZWYsIFBvc2l0aW9uU3RyYXRlZ3ksIFNjcm9sbFN0cmF0ZWd5T3B0aW9ucyB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudFJlZiwgRWxlbWVudFJlZiwgaW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBMdU11bHRpU2VsZWN0UGFuZWxDb21wb25lbnQgfSBmcm9tICcuLi9wYW5lbCc7XG5pbXBvcnQgeyBJTHVNdWx0aVNlbGVjdFBhbmVsRGF0YSwgTVVMVElfU0VMRUNUX1BBTkVMX0RBVEEgfSBmcm9tICcuLi9zZWxlY3QubW9kZWwnO1xuaW1wb3J0IHsgTHVNdWx0aVNlbGVjdFBhbmVsUmVmIH0gZnJvbSAnLi9wYW5lbC5tb2RlbCc7XG5cbmNsYXNzIE11bHRpU2VsZWN0UGFuZWxSZWY8VD4gZXh0ZW5kcyBMdU11bHRpU2VsZWN0UGFuZWxSZWY8VD4ge1xuXHRpbnN0YW5jZTogTHVNdWx0aVNlbGVjdFBhbmVsQ29tcG9uZW50PFQ+O1xuXHRwcml2YXRlIHBhbmVsUmVmOiBDb21wb25lbnRSZWY8THVNdWx0aVNlbGVjdFBhbmVsQ29tcG9uZW50PFQ+Pjtcblx0cHJpdmF0ZSBwb3J0YWxSZWY6IENvbXBvbmVudFBvcnRhbDxMdU11bHRpU2VsZWN0UGFuZWxDb21wb25lbnQ8VD4+O1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcblx0XHRwYXJlbnRJbmplY3RvcjogSW5qZWN0b3IsXG5cdFx0cGFuZWxEYXRhOiBJTHVNdWx0aVNlbGVjdFBhbmVsRGF0YTxUPixcblx0XHRwcm90ZWN0ZWQgZGVmYXVsdFBvc2l0aW9uU3RyYXRlZ3k6IFBvc2l0aW9uU3RyYXRlZ3ksXG5cdFx0cHJvdGVjdGVkIGV4cGFuZGVkUG9zaXRpb25TdHJhdGVneTogUG9zaXRpb25TdHJhdGVneSxcblx0KSB7XG5cdFx0c3VwZXIoKTtcblxuXHRcdGNvbnN0IGluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcblx0XHRcdHByb3ZpZGVyczogW1xuXHRcdFx0XHR7IHByb3ZpZGU6IEx1TXVsdGlTZWxlY3RQYW5lbFJlZiwgdXNlVmFsdWU6IHRoaXMgfSxcblx0XHRcdFx0eyBwcm92aWRlOiBNVUxUSV9TRUxFQ1RfUEFORUxfREFUQSwgdXNlVmFsdWU6IHBhbmVsRGF0YSB9LFxuXHRcdFx0XSxcblx0XHRcdHBhcmVudDogcGFyZW50SW5qZWN0b3IsXG5cdFx0fSk7XG5cblx0XHR0aGlzLnBvcnRhbFJlZiA9IG5ldyBDb21wb25lbnRQb3J0YWw8THVNdWx0aVNlbGVjdFBhbmVsQ29tcG9uZW50PFQ+PihMdU11bHRpU2VsZWN0UGFuZWxDb21wb25lbnQsIHVuZGVmaW5lZCwgaW5qZWN0b3IpO1xuXHRcdHRoaXMucGFuZWxSZWYgPSBvdmVybGF5UmVmLmF0dGFjaCh0aGlzLnBvcnRhbFJlZik7XG5cdFx0dGhpcy5pbnN0YW5jZSA9IHRoaXMucGFuZWxSZWYuaW5zdGFuY2U7XG5cblx0XHRvdmVybGF5UmVmXG5cdFx0XHQuYmFja2Ryb3BDbGljaygpXG5cdFx0XHQucGlwZSh0YWtlVW50aWwodGhpcy5jbG9zZWQpKVxuXHRcdFx0LnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuXHR9XG5cblx0ZW1pdFZhbHVlKHZhbHVlOiBUW10pOiB2b2lkIHtcblx0XHR0aGlzLnZhbHVlQ2hhbmdlZC5lbWl0KHZhbHVlKTtcblx0fVxuXG5cdHVwZGF0ZVNlbGVjdGVkT3B0aW9ucyhzZWxlY3RlZE9wdGlvbnM6IFRbXSk6IHZvaWQge1xuXHRcdHRoaXMuaW5zdGFuY2Uuc2VsZWN0ZWRPcHRpb25zID0gc2VsZWN0ZWRPcHRpb25zO1xuXHRcdC8vIFJ1biBjaGFuZ2UgZGV0ZWN0aW9uIG9uIHRoZSBwYW5lbCBjb21wb25lbnRcblx0XHR0aGlzLnBhbmVsUmVmLmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZikubWFya0ZvckNoZWNrKCk7XG5cdH1cblxuXHR1c2VFeHBhbmRlZFBvc2l0aW9uKCk6IHZvaWQge1xuXHRcdHRoaXMub3ZlcmxheVJlZi51cGRhdGVQb3NpdGlvblN0cmF0ZWd5KHRoaXMuZXhwYW5kZWRQb3NpdGlvblN0cmF0ZWd5KTtcblx0fVxuXG5cdHVzZURlZmF1bHRQb3NpdGlvbigpOiB2b2lkIHtcblx0XHR0aGlzLm92ZXJsYXlSZWYudXBkYXRlUG9zaXRpb25TdHJhdGVneSh0aGlzLmRlZmF1bHRQb3NpdGlvblN0cmF0ZWd5KTtcblx0fVxuXG5cdG92ZXJyaWRlIGNsb3NlKCk6IHZvaWQge1xuXHRcdHN1cGVyLmNsb3NlKCk7XG5cdFx0dGhpcy5wYW5lbFJlZi5kZXN0cm95KCk7XG5cdFx0dGhpcy5vdmVybGF5UmVmLmRldGFjaCgpO1xuXHR9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMdU11bHRpU2VsZWN0UGFuZWxSZWZGYWN0b3J5IHtcblx0cHJvdGVjdGVkIG92ZXJsYXkgPSBpbmplY3QoT3ZlcmxheSk7XG5cdHByb3RlY3RlZCBlbGVtZW50UmVmID0gaW5qZWN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PihFbGVtZW50UmVmKTtcblx0cHJvdGVjdGVkIHBvc2l0aW9uQnVpbGRlciA9IGluamVjdChPdmVybGF5UG9zaXRpb25CdWlsZGVyKTtcblx0cHJvdGVjdGVkIHNjcm9sbFN0cmF0ZWdpZXMgPSBpbmplY3QoU2Nyb2xsU3RyYXRlZ3lPcHRpb25zKTtcblx0cHJvdGVjdGVkIHBhcmVudEluamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcblxuXHRidWlsZFBhbmVsUmVmPFQ+KHBhbmVsRGF0YTogSUx1TXVsdGlTZWxlY3RQYW5lbERhdGE8VD4sIGRlZmF1bHRPdmVybGF5Q29uZmlnT3ZlcnJpZGU6IE92ZXJsYXlDb25maWcgPSB7fSwgZXhwYW5kZWRQb3NpdGlvblN0cmF0ZWd5PzogUG9zaXRpb25TdHJhdGVneSk6IEx1TXVsdGlTZWxlY3RQYW5lbFJlZjxUPiB7XG5cdFx0Y29uc3QgZGVmYXVsdE92ZXJsYXlDb25maWcgPSB0aGlzLmJ1aWxkRGVmYXVsdE92ZXJsYXlDb25maWcoZGVmYXVsdE92ZXJsYXlDb25maWdPdmVycmlkZSk7XG5cdFx0ZXhwYW5kZWRQb3NpdGlvblN0cmF0ZWd5ID8/PSB0aGlzLmJ1aWxkRXhwYW5kZWRQb3NpdGlvblN0cmF0ZWd5KCk7XG5cblx0XHRjb25zdCBvdmVybGF5UmVmID0gdGhpcy5vdmVybGF5LmNyZWF0ZShkZWZhdWx0T3ZlcmxheUNvbmZpZyk7XG5cblx0XHRvdmVybGF5UmVmLmhvc3RFbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdoZWlnaHQnO1xuXHRcdG92ZXJsYXlSZWYuaG9zdEVsZW1lbnQuc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gJ3ZhcigtLWNvbW1vbnMtYW5pbWF0aW9ucy1kdXJhdGlvbnMtc3RhbmRhcmQpJztcblxuXHRcdHJldHVybiBuZXcgTXVsdGlTZWxlY3RQYW5lbFJlZihvdmVybGF5UmVmLCB0aGlzLnBhcmVudEluamVjdG9yLCBwYW5lbERhdGEsIGRlZmF1bHRPdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3ksIGV4cGFuZGVkUG9zaXRpb25TdHJhdGVneSk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgYnVpbGREZWZhdWx0T3ZlcmxheUNvbmZpZyhvdmVybGF5Q29uZmlnT3ZlcnJpZGU6IE92ZXJsYXlDb25maWcgPSB7fSk6IE92ZXJsYXlDb25maWcge1xuXHRcdGNvbnN0IG92ZXJsYXlDb25maWc6IE92ZXJsYXlDb25maWcgPSB7IC4uLm92ZXJsYXlDb25maWdPdmVycmlkZSB9O1xuXG5cdFx0Y29uc3QgY29uZmlnID0geyBvdmVybGFwSW5wdXQ6IGZhbHNlLCBvZmZzZXRZOiAyIH07XG5cdFx0b3ZlcmxheUNvbmZpZy5wb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5wb3NpdGlvbkJ1aWxkZXJcblx0XHRcdC5mbGV4aWJsZUNvbm5lY3RlZFRvKHRoaXMuZWxlbWVudFJlZilcblx0XHRcdC53aXRoVmlld3BvcnRNYXJnaW4oMTApXG5cdFx0XHQud2l0aFBvc2l0aW9ucyhbXG5cdFx0XHRcdHRoaXMuYnVpbGRQb3NpdGlvbignYm90dG9tJywgJ3JpZ2h0JywgY29uZmlnKSxcblx0XHRcdFx0dGhpcy5idWlsZFBvc2l0aW9uKCdib3R0b20nLCAnbGVmdCcsIGNvbmZpZyksXG5cdFx0XHRcdHRoaXMuYnVpbGRQb3NpdGlvbigndG9wJywgJ3JpZ2h0JywgY29uZmlnKSxcblx0XHRcdFx0dGhpcy5idWlsZFBvc2l0aW9uKCd0b3AnLCAnbGVmdCcsIGNvbmZpZyksXG5cdFx0XHRdKTtcblx0XHRvdmVybGF5Q29uZmlnLnNjcm9sbFN0cmF0ZWd5ID0gdGhpcy5zY3JvbGxTdHJhdGVnaWVzLnJlcG9zaXRpb24oKTtcblx0XHRvdmVybGF5Q29uZmlnLm1pbldpZHRoID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xpZW50V2lkdGg7XG5cdFx0b3ZlcmxheUNvbmZpZy5tYXhXaWR0aCA9ICcxMDB2dyc7XG5cblx0XHRyZXR1cm4gb3ZlcmxheUNvbmZpZztcblx0fVxuXG5cdGJ1aWxkRXhwYW5kZWRQb3NpdGlvblN0cmF0ZWd5KCk6IFBvc2l0aW9uU3RyYXRlZ3kge1xuXHRcdGNvbnN0IGNvbmZpZyA9IHsgb3ZlcmxhcElucHV0OiB0cnVlLCBvZmZzZXRYOiAtNCwgb2Zmc2V0WTogLTQgfTtcblx0XHRyZXR1cm4gdGhpcy5wb3NpdGlvbkJ1aWxkZXJcblx0XHRcdC5mbGV4aWJsZUNvbm5lY3RlZFRvKHRoaXMuZWxlbWVudFJlZilcblx0XHRcdC53aXRoVmlld3BvcnRNYXJnaW4oMTApXG5cdFx0XHQud2l0aFBvc2l0aW9ucyhbXG5cdFx0XHRcdHRoaXMuYnVpbGRQb3NpdGlvbigndG9wJywgJ3JpZ2h0JywgY29uZmlnKSxcblx0XHRcdFx0dGhpcy5idWlsZFBvc2l0aW9uKCd0b3AnLCAnbGVmdCcsIGNvbmZpZyksXG5cdFx0XHRcdHRoaXMuYnVpbGRQb3NpdGlvbignYm90dG9tJywgJ3JpZ2h0JywgY29uZmlnKSxcblx0XHRcdFx0dGhpcy5idWlsZFBvc2l0aW9uKCdib3R0b20nLCAnbGVmdCcsIGNvbmZpZyksXG5cdFx0XHRdKTtcblx0fVxuXG5cdHByb3RlY3RlZCBidWlsZFBvc2l0aW9uKFxuXHRcdHlEaXJlY3Rpb246ICd0b3AnIHwgJ2JvdHRvbScsXG5cdFx0eERpcmVjdGlvbjogJ2xlZnQnIHwgJ3JpZ2h0Jyxcblx0XHRjb25maWc6IHtcblx0XHRcdG9mZnNldFg/OiBudW1iZXI7XG5cdFx0XHRvZmZzZXRZPzogbnVtYmVyO1xuXHRcdFx0b3ZlcmxhcElucHV0OiBib29sZWFuO1xuXHRcdH0sXG5cdCk6IENvbm5lY3RlZFBvc2l0aW9uIHtcblx0XHRjb25zdCBvcmlnaW5YID0geERpcmVjdGlvbiA9PT0gJ3JpZ2h0JyA/ICdzdGFydCcgOiAnZW5kJztcblx0XHRjb25zdCBvdmVybGF5WCA9IG9yaWdpblg7XG5cblx0XHRjb25zdCBvcHBvc2l0ZVlEaXJlY3Rpb24gPSB5RGlyZWN0aW9uID09PSAndG9wJyA/ICdib3R0b20nIDogJ3RvcCc7XG5cdFx0Y29uc3QgeyBvcmlnaW5ZLCBvdmVybGF5WSB9ID0gY29uZmlnLm92ZXJsYXBJbnB1dFxuXHRcdFx0PyAoe1xuXHRcdFx0XHRcdG9yaWdpblk6IG9wcG9zaXRlWURpcmVjdGlvbixcblx0XHRcdFx0XHRvdmVybGF5WTogb3Bwb3NpdGVZRGlyZWN0aW9uLFxuXHRcdFx0ICB9IGFzIGNvbnN0KVxuXHRcdFx0OiAoeyBvcmlnaW5ZOiB5RGlyZWN0aW9uLCBvdmVybGF5WTogb3Bwb3NpdGVZRGlyZWN0aW9uIH0gYXMgY29uc3QpO1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdG9yaWdpblgsXG5cdFx0XHRvcmlnaW5ZLFxuXHRcdFx0b3ZlcmxheVgsXG5cdFx0XHRvdmVybGF5WSxcblx0XHRcdC4uLihjb25maWcub2Zmc2V0WCA/IHsgb2Zmc2V0WDogeERpcmVjdGlvbiA9PT0gJ3JpZ2h0JyA/IGNvbmZpZy5vZmZzZXRYIDogLWNvbmZpZy5vZmZzZXRYIH0gOiB7fSksXG5cdFx0XHQuLi4oY29uZmlnLm9mZnNldFkgPyB7IG9mZnNldFk6IHlEaXJlY3Rpb24gPT09ICdib3R0b20nID8gY29uZmlnLm9mZnNldFkgOiAtY29uZmlnLm9mZnNldFkgfSA6IHt9KSxcblx0XHR9O1xuXHR9XG59XG4iXX0=