import { merge, of, Subject } from 'rxjs';
import { catchError, map, scan, share, startWith, switchMap } from 'rxjs/operators';
export class ALuApiOptionSearcher {
    set clue$(clue$) {
        // this.initObservables(clue$);
        this._clue$ = clue$;
    }
    constructor(_service) {
        this._service = _service;
        this.outOptions$ = new Subject();
    }
    init() {
        this.initObservables();
    }
    onOpen() {
        this.resetClue();
    }
    onClose() {
        this.clearOptions();
    }
    initObservables() {
        // this._clue$ = clue$.pipe(share());
        const results$ = this._clue$.pipe(switchMap((clue) => this._service.searchAll(clue)), catchError(() => of([])), share());
        results$.subscribe((items) => this.outOptions$.next(items));
        this.loading$ = merge(this._clue$.pipe(map(() => true)), results$.pipe(map(() => false)));
        this.empty$ = results$.pipe(map((o) => o.length === 0));
    }
    clearOptions() {
        this.outOptions$.next([]);
    }
}
export class ALuApiOptionPagedSearcher extends ALuApiOptionSearcher {
    constructor(service) {
        super(service);
        this.outOptions$ = new Subject();
        this._loading = false;
        this._page$ = new Subject();
        this._options = [];
    }
    onOpen() {
        this.resetClue();
    }
    onScrollBottom() {
        if (!this._loading && !this._isLastPage) {
            this._page$.next();
        }
    }
    initObservables() {
        const pager$ = this._page$.pipe(scan((acc) => acc + 1, 0), startWith(0));
        const query$ = this._clue$.pipe(switchMap((clue) => pager$.pipe(map((page) => [page, clue]))), share());
        const results$ = query$.pipe(switchMap(([page, clue]) => this._service.searchPaged(clue, page).pipe(catchError(() => of([])), map((items) => [items, page]))), share());
        results$.subscribe(([items, page]) => {
            if (page === 0) {
                this._options = [...items];
            }
            else {
                this._options.push(...items);
            }
            this._isLastPage = !items.length;
            this.outOptions$.next([...this._options]);
        });
        this.loading$ = merge(query$.pipe(map(() => true)), results$.pipe(map(() => false)));
        this.loading$.subscribe((l) => (this._loading = l));
        this.empty$ = this.outOptions$.pipe(map((o) => o.length === 0));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLXNlYXJjaGVyLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvbmcvYXBpL3NlbGVjdC9zZWFyY2hlci9hcGktc2VhcmNoZXIubW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXBGLE1BQU0sT0FBZ0Isb0JBQW9CO0lBU3pDLElBQUksS0FBSyxDQUFDLEtBQXlCO1FBQ2xDLCtCQUErQjtRQUMvQixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztJQUNyQixDQUFDO0lBQ0QsWUFBc0IsUUFBVztRQUFYLGFBQVEsR0FBUixRQUFRLENBQUc7UUFWakMsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO0lBVUcsQ0FBQztJQUNyQyxJQUFJO1FBQ0gsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFDRCxNQUFNO1FBQ0wsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFDRCxPQUFPO1FBQ04sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFDUyxlQUFlO1FBQ3hCLHFDQUFxQztRQUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDaEMsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUNsRCxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQ3hCLEtBQUssRUFB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Q0FBQzthQUM3QjtZQUNELElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7Q0FFRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElMdU9uT3BlblN1YnNjcmliZXIsIElMdU9uU2Nyb2xsQm90dG9tU3Vic2NyaWJlciB9IGZyb20gJ0BsdWNjYS1mcm9udC9uZy9jb3JlJztcbmltcG9ydCB7IG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzY2FuLCBzaGFyZSwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBJTHVBcGlTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZS9pbmRleCc7XG5pbXBvcnQgeyBJTHVBcGlPcHRpb25GZWVkZXIgfSBmcm9tICcuLi9mZWVkZXIvaW5kZXgnO1xuXG5leHBvcnQgdHlwZSBJTHVBcGlPcHRpb25TZWFyY2hlcjxUIGV4dGVuZHMgaW1wb3J0KCcuLi8uLi9hcGkubW9kZWwnKS5JTHVBcGlJdGVtID0gaW1wb3J0KCcuLi8uLi9hcGkubW9kZWwnKS5JTHVBcGlJdGVtPiA9IElMdUFwaU9wdGlvbkZlZWRlcjxUPjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFMdUFwaU9wdGlvblNlYXJjaGVyPFQgZXh0ZW5kcyBpbXBvcnQoJy4uLy4uL2FwaS5tb2RlbCcpLklMdUFwaUl0ZW0gPSBpbXBvcnQoJy4uLy4uL2FwaS5tb2RlbCcpLklMdUFwaUl0ZW0sIFMgZXh0ZW5kcyBJTHVBcGlTZXJ2aWNlPFQ+ID0gSUx1QXBpU2VydmljZTxUPj5cblx0aW1wbGVtZW50cyBJTHVBcGlPcHRpb25GZWVkZXI8VD4sIElMdU9uT3BlblN1YnNjcmliZXJcbntcblx0b3V0T3B0aW9ucyQgPSBuZXcgU3ViamVjdDxUW10+KCk7XG5cdGxvYWRpbmckOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXHRlbXB0eSQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cblx0cHJvdGVjdGVkIF9jbHVlJDogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG5cdHNldCBjbHVlJChjbHVlJDogT2JzZXJ2YWJsZTxzdHJpbmc+KSB7XG5cdFx0Ly8gdGhpcy5pbml0T2JzZXJ2YWJsZXMoY2x1ZSQpO1xuXHRcdHRoaXMuX2NsdWUkID0gY2x1ZSQ7XG5cdH1cblx0Y29uc3RydWN0b3IocHJvdGVjdGVkIF9zZXJ2aWNlOiBTKSB7fVxuXHRpbml0KCkge1xuXHRcdHRoaXMuaW5pdE9ic2VydmFibGVzKCk7XG5cdH1cblx0b25PcGVuKCkge1xuXHRcdHRoaXMucmVzZXRDbHVlKCk7XG5cdH1cblx0b25DbG9zZSgpIHtcblx0XHR0aGlzLmNsZWFyT3B0aW9ucygpO1xuXHR9XG5cdHByb3RlY3RlZCBpbml0T2JzZXJ2YWJsZXMoKSB7XG5cdFx0Ly8gdGhpcy5fY2x1ZSQgPSBjbHVlJC5waXBlKHNoYXJlKCkpO1xuXHRcdGNvbnN0IHJlc3VsdHMkID0gdGhpcy5fY2x1ZSQucGlwZShcblx0XHRcdHN3aXRjaE1hcCgoY2x1ZSkgPT4gdGhpcy5fc2VydmljZS5zZWFyY2hBbGwoY2x1ZSkpLFxuXHRcdFx0Y2F0Y2hFcnJvcigoKSA9PiBvZihbXSkpLFxuXHRcdFx0c2hhcmUoKSxcblx0XHQpO1xuXG5cdFx0cmVzdWx0cyQuc3Vic2NyaWJlKChpdGVtcykgPT4gdGhpcy5vdXRPcHRpb25zJC5uZXh0KGl0ZW1zKSk7XG5cdFx0dGhpcy5sb2FkaW5nJCA9IG1lcmdlKHRoaXMuX2NsdWUkLnBpcGUobWFwKCgpID0+IHRydWUpKSwgcmVzdWx0cyQucGlwZShtYXAoKCkgPT4gZmFsc2UpKSk7XG5cdFx0dGhpcy5lbXB0eSQgPSByZXN1bHRzJC5waXBlKG1hcCgobykgPT4gby5sZW5ndGggPT09IDApKTtcblx0fVxuXHRhYnN0cmFjdCByZXNldENsdWUoKTtcblx0cHJvdGVjdGVkIGNsZWFyT3B0aW9ucygpIHtcblx0XHR0aGlzLm91dE9wdGlvbnMkLm5leHQoW10pO1xuXHR9XG59XG5cbmV4cG9ydCB0eXBlIElMdUFwaU9wdGlvblBhZ2VkU2VhcmNoZXI8VCBleHRlbmRzIGltcG9ydCgnLi4vLi4vYXBpLm1vZGVsJykuSUx1QXBpSXRlbSA9IGltcG9ydCgnLi4vLi4vYXBpLm1vZGVsJykuSUx1QXBpSXRlbT4gPSBJTHVBcGlPcHRpb25TZWFyY2hlcjxUPjtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEFMdUFwaU9wdGlvblBhZ2VkU2VhcmNoZXI8VCBleHRlbmRzIGltcG9ydCgnLi4vLi4vYXBpLm1vZGVsJykuSUx1QXBpSXRlbSA9IGltcG9ydCgnLi4vLi4vYXBpLm1vZGVsJykuSUx1QXBpSXRlbSwgUyBleHRlbmRzIElMdUFwaVNlcnZpY2U8VD4gPSBJTHVBcGlTZXJ2aWNlPFQ+PlxuXHRleHRlbmRzIEFMdUFwaU9wdGlvblNlYXJjaGVyPFQsIFM+XG5cdGltcGxlbWVudHMgSUx1QXBpT3B0aW9uUGFnZWRTZWFyY2hlcjxUPiwgSUx1T25TY3JvbGxCb3R0b21TdWJzY3JpYmVyXG57XG5cdG92ZXJyaWRlIG91dE9wdGlvbnMkID0gbmV3IFN1YmplY3Q8VFtdPigpO1xuXHRvdmVycmlkZSBsb2FkaW5nJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcblx0cHJvdGVjdGVkIF9sb2FkaW5nID0gZmFsc2U7XG5cdHByb3RlY3RlZCBfcGFnZSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXHRwcm90ZWN0ZWQgX2lzTGFzdFBhZ2U6IGJvb2xlYW47XG5cdHByb3RlY3RlZCBfb3B0aW9uczogVFtdID0gW107XG5cblx0Y29uc3RydWN0b3Ioc2VydmljZTogUykge1xuXHRcdHN1cGVyKHNlcnZpY2UpO1xuXHR9XG5cdG92ZXJyaWRlIG9uT3BlbigpIHtcblx0XHR0aGlzLnJlc2V0Q2x1ZSgpO1xuXHR9XG5cdG9uU2Nyb2xsQm90dG9tKCkge1xuXHRcdGlmICghdGhpcy5fbG9hZGluZyAmJiAhdGhpcy5faXNMYXN0UGFnZSkge1xuXHRcdFx0dGhpcy5fcGFnZSQubmV4dCgpO1xuXHRcdH1cblx0fVxuXG5cdHByb3RlY3RlZCBvdmVycmlkZSBpbml0T2JzZXJ2YWJsZXMoKSB7XG5cdFx0Y29uc3QgcGFnZXIkID0gdGhpcy5fcGFnZSQucGlwZShcblx0XHRcdHNjYW4oKGFjYykgPT4gYWNjICsgMSwgMCksXG5cdFx0XHRzdGFydFdpdGgoMCksXG5cdFx0KTtcblx0XHRjb25zdCBxdWVyeSQgPSB0aGlzLl9jbHVlJC5waXBlKFxuXHRcdFx0c3dpdGNoTWFwKChjbHVlKSA9PiBwYWdlciQucGlwZShtYXA8bnVtYmVyLCBbbnVtYmVyLCBzdHJpbmddPigocGFnZSkgPT4gW3BhZ2UsIGNsdWVdKSkpLFxuXHRcdFx0c2hhcmUoKSxcblx0XHQpO1xuXG5cdFx0Y29uc3QgcmVzdWx0cyQgPSBxdWVyeSQucGlwZShcblx0XHRcdHN3aXRjaE1hcCgoW3BhZ2UsIGNsdWVdKSA9PlxuXHRcdFx0XHR0aGlzLl9zZXJ2aWNlLnNlYXJjaFBhZ2VkKGNsdWUsIHBhZ2UpLnBpcGUoXG5cdFx0XHRcdFx0Y2F0Y2hFcnJvcigoKSA9PiBvZihbXSkpLFxuXHRcdFx0XHRcdG1hcDxUW10sIFtUW10sIG51bWJlcl0+KChpdGVtcykgPT4gW2l0ZW1zLCBwYWdlXSksXG5cdFx0XHRcdCksXG5cdFx0XHQpLFxuXHRcdFx0c2hhcmUoKSxcblx0XHQpO1xuXG5cdFx0cmVzdWx0cyQuc3Vic2NyaWJlKChbaXRlbXMsIHBhZ2VdKSA9PiB7XG5cdFx0XHRpZiAocGFnZSA9PT0gMCkge1xuXHRcdFx0XHR0aGlzLl9vcHRpb25zID0gWy4uLml0ZW1zXTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHRoaXMuX29wdGlvbnMucHVzaCguLi5pdGVtcyk7XG5cdFx0XHR9XG5cdFx0XHR0aGlzLl9pc0xhc3RQYWdlID0gIWl0ZW1zLmxlbmd0aDtcblx0XHRcdHRoaXMub3V0T3B0aW9ucyQubmV4dChbLi4udGhpcy5fb3B0aW9uc10pO1xuXHRcdH0pO1xuXHRcdHRoaXMubG9hZGluZyQgPSBtZXJnZShxdWVyeSQucGlwZShtYXAoKCkgPT4gdHJ1ZSkpLCByZXN1bHRzJC5waXBlKG1hcCgoKSA9PiBmYWxzZSkpKTtcblx0XHR0aGlzLmxvYWRpbmckLnN1YnNjcmliZSgobCkgPT4gKHRoaXMuX2xvYWRpbmcgPSBsKSk7XG5cdFx0dGhpcy5lbXB0eSQgPSB0aGlzLm91dE9wdGlvbnMkLnBpcGUobWFwKChvKSA9PiBvLmxlbmd0aCA9PT0gMCkpO1xuXHR9XG5cdGFic3RyYWN0IG92ZXJyaWRlIHJlc2V0Q2x1ZSgpO1xufVxuIl19