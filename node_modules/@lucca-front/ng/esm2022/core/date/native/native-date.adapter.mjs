import { formatDate, FormatWidth, getLocaleDateFormat } from '@angular/common';
import { Inject, Injectable, LOCALE_ID, Optional } from '@angular/core';
import { ALuDateAdapter } from '../date-adapter.class';
import { ELuDateGranularity } from '../date-granularity.enum';
import { luDefaultNativeDateAdapterOptions, LU_NATIVE_DATE_ADAPTER_OPTIONS } from './native-date.option';
import * as i0 from "@angular/core";
class LuNativeDateAdapter extends ALuDateAdapter {
    constructor(_locale, _options) {
        super();
        this._locale = _locale;
        this._options = _options;
        this._regex = /[/,.\-\s]/i;
        this._order = {
            date: 0,
            month: 1,
            year: 2,
        };
        this._options = this._options || luDefaultNativeDateAdapterOptions;
        this.initOrder();
    }
    initOrder() {
        const format = getLocaleDateFormat(this._locale, FormatWidth.Short);
        const groups = format.split(this._regex);
        groups.forEach((g, i) => {
            if (g.indexOf('d') !== -1) {
                this._order.date = i;
            }
            if (g.indexOf('M') !== -1) {
                this._order.month = i;
            }
            if (g.indexOf('y') !== -1) {
                this._order.year = i;
            }
        });
    }
    extract(text, granularity = ELuDateGranularity.day) {
        const groups = text.split(this._regex);
        let date = 1, month = 1, year = 1;
        switch (granularity) {
            case ELuDateGranularity.year:
                year = parseInt(groups[Math.max(this._order.year - 2, 0)], 10);
                break;
            case ELuDateGranularity.month:
                month = parseInt(groups[Math.max(this._order.month - 1, 0)], 10);
                year = parseInt(groups[Math.max(this._order.year - 1, 0)], 10) || new Date().getFullYear();
                break;
            case ELuDateGranularity.day:
            default:
                date = parseInt(groups[this._order.date], 10);
                month = parseInt(groups[this._order.month], 10);
                year = parseInt(groups[this._order.year], 10) || new Date().getFullYear();
        }
        return { date, month, year };
    }
    isParsable(text, granularity = ELuDateGranularity.day) {
        if (!text) {
            return false;
        }
        const groups = text.split(this._regex);
        const dayTextInvalid = granularity === ELuDateGranularity.day && groups.length !== 3;
        const monthTextInvalid = granularity === ELuDateGranularity.month && groups.length !== 2;
        const yearTextInvalid = granularity === ELuDateGranularity.year && groups.length !== 1;
        if (dayTextInvalid || monthTextInvalid || yearTextInvalid) {
            return false;
        }
        try {
            const { date, month, year } = this.extract(text, granularity);
            // When year is equal or greater than 10_000 ISO string goes from 2000-01-01 to +010000-01-01 which is not supported by backends
            if (year >= 10000) {
                return false;
            }
            let d;
            if (this._options.useUtc) {
                d = new Date(Date.UTC(year, month - 1, date));
            }
            else {
                d = new Date(year, month - 1, date);
            }
            // checking if its a valid date
            // https://stackoverflow.com/questions/1353684/detecting-an-invalid-date-date-instance-in-javascript
            if (!(d instanceof Date)) {
                return false;
            }
            if (isNaN(d.getTime())) {
                return false;
            }
            // d is a valid date, but
            // as i can write new Date(1234, 56, 78) and mr javascript accepts it
            // i check now that the generated date has the same year/month/date as what i entered
            if (this._options.useUtc) {
                if (d.getUTCFullYear() !== year) {
                    return false;
                }
                if (d.getUTCMonth() !== month - 1) {
                    return false;
                }
                if (d.getUTCDate() !== date) {
                    return false;
                }
            }
            else {
                if (d.getFullYear() !== year) {
                    return false;
                }
                if (d.getMonth() !== month - 1) {
                    return false;
                }
                if (d.getDate() !== date) {
                    return false;
                }
            }
            return true;
        }
        catch {
            return false;
        }
    }
    parse(text, granularity = ELuDateGranularity.day) {
        if (!text) {
            return undefined;
        }
        if (!this.isParsable(text, granularity)) {
            return this.forgeInvalid();
        }
        const { date, month, year } = this.extract(text, granularity);
        return this.forge(year, month, date);
    }
    format(d, format) {
        if (this._options.useUtc) {
            return formatDate(d, format, this._locale, 'UTC');
        }
        else {
            return formatDate(d, format, this._locale);
        }
    }
    forge(year, month, date) {
        if (this._options.useUtc) {
            return new Date(Date.UTC(year, month - 1, date)); // month-1 cuz 0 -> january
        }
        else {
            return new Date(year, month - 1, date); // month-1 cuz 0 -> january
        }
    }
    forgeToday() {
        if (this._options.useUtc) {
            const nonUTCToday = new Date();
            return new Date(Date.UTC(nonUTCToday.getFullYear(), nonUTCToday.getMonth(), nonUTCToday.getDate()));
        }
        else {
            const today = new Date();
            return new Date(today.getFullYear(), today.getMonth(), today.getDate());
        }
    }
    forgeInvalid() {
        return new Date('Invalid Date');
    }
    isValid(d) {
        if (!(d instanceof Date)) {
            return false;
        }
        if (isNaN(d.getTime())) {
            return false;
        }
        return true;
    }
    clone(d) {
        return new Date(d);
    }
    getYear(d) {
        if (this._options.useUtc) {
            return d.getUTCFullYear();
        }
        else {
            return d.getFullYear();
        }
    }
    getMonth(d) {
        if (this._options.useUtc) {
            return d.getUTCMonth() + 1;
        }
        else {
            return d.getMonth() + 1;
        }
    }
    getDate(d) {
        if (this._options.useUtc) {
            return d.getUTCDate();
        }
        else {
            return d.getDate();
        }
    }
    getDay(d) {
        if (this._options.useUtc) {
            return d.getUTCDay();
        }
        else {
            return d.getDay();
        }
    }
    add(d, count, granularity) {
        let year = this.getYear(d);
        let month = this.getMonth(d);
        let date = this.getDate(d);
        switch (granularity) {
            case ELuDateGranularity.decade:
                year += 10 * count;
                break;
            case ELuDateGranularity.year:
                year += count;
                break;
            case ELuDateGranularity.month:
                month += count;
                break;
            case ELuDateGranularity.day:
                date += count;
                break;
        }
        return this.forge(year, month, date);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuNativeDateAdapter, deps: [{ token: LOCALE_ID }, { token: LU_NATIVE_DATE_ADAPTER_OPTIONS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuNativeDateAdapter }); }
}
export { LuNativeDateAdapter };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.3", ngImport: i0, type: LuNativeDateAdapter, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [LOCALE_ID]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [LU_NATIVE_DATE_ADAPTER_OPTIONS]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlLWRhdGUuYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL25nL2NvcmUvZGF0ZS9uYXRpdmUvbmF0aXZlLWRhdGUuYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXZELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlELE9BQU8sRUFBK0IsaUNBQWlDLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFFdEksTUFDYSxtQkFBb0IsU0FBUSxjQUFvQjtJQU81RCxZQUM0QixPQUFlLEVBR2xDLFFBQXFDO1FBRTdDLEtBQUssRUFBRSxDQUFDO1FBTG1CLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFHbEMsYUFBUSxHQUFSLFFBQVEsQ0FBNkI7UUFWdEMsV0FBTSxHQUFHLFlBQVksQ0FBQztRQUN0QixXQUFNLEdBQUc7WUFDaEIsSUFBSSxFQUFFLENBQUM7WUFDUCxLQUFLLEVBQUUsQ0FBQztZQUNSLElBQUksRUFBRSxDQUFDO1NBQ1AsQ0FBQztRQVFELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxpQ0FBaUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUNPLFNBQVM7UUFDaEIsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEUsTUFBTSxNQUFNLEdB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QVM7OzBCQUNoQixNQUFNOzJCQUFDLDhCQUE4Qjs7MEJBQ3JDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmb3JtYXREYXRlLCBGb3JtYXRXaWR0aCwgZ2V0TG9jYWxlRGF0ZUZvcm1hdCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIExPQ0FMRV9JRCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFMdURhdGVBZGFwdGVyIH0gZnJvbSAnLi4vZGF0ZS1hZGFwdGVyLmNsYXNzJztcbmltcG9ydCB7IElMdURhdGVBZGFwdGVyIH0gZnJvbSAnLi4vZGF0ZS1hZGFwdGVyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBFTHVEYXRlR3JhbnVsYXJpdHkgfSBmcm9tICcuLi9kYXRlLWdyYW51bGFyaXR5LmVudW0nO1xuaW1wb3J0IHsgSUx1TmF0aXZlRGF0ZUFkYXB0ZXJPcHRpb25zLCBsdURlZmF1bHROYXRpdmVEYXRlQWRhcHRlck9wdGlvbnMsIExVX05BVElWRV9EQVRFX0FEQVBURVJfT1BUSU9OUyB9IGZyb20gJy4vbmF0aXZlLWRhdGUub3B0aW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEx1TmF0aXZlRGF0ZUFkYXB0ZXIgZXh0ZW5kcyBBTHVEYXRlQWRhcHRlcjxEYXRlPiBpbXBsZW1lbnRzIElMdURhdGVBZGFwdGVyPERhdGU+IHtcblx0cHJpdmF0ZSBfcmVnZXggPSAvWy8sLlxcLVxcc10vaTtcblx0cHJpdmF0ZSBfb3JkZXIgPSB7XG5cdFx0ZGF0ZTogMCxcblx0XHRtb250aDogMSxcblx0XHR5ZWFyOiAyLFxuXHR9O1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRASW5qZWN0KExPQ0FMRV9JRCkgcHJpdmF0ZSBfbG9jYWxlOiBzdHJpbmcsXG5cdFx0QEluamVjdChMVV9OQVRJVkVfREFURV9BREFQVEVSX09QVElPTlMpXG5cdFx0QE9wdGlvbmFsKClcblx0XHRwcml2YXRlIF9vcHRpb25zOiBJTHVOYXRpdmVEYXRlQWRhcHRlck9wdGlvbnMsXG5cdCkge1xuXHRcdHN1cGVyKCk7XG5cdFx0dGhpcy5fb3B0aW9ucyA9IHRoaXMuX29wdGlvbnMgfHwgbHVEZWZhdWx0TmF0aXZlRGF0ZUFkYXB0ZXJPcHRpb25zO1xuXHRcdHRoaXMuaW5pdE9yZGVyKCk7XG5cdH1cblx0cHJpdmF0ZSBpbml0T3JkZXIoKSB7XG5cdFx0Y29uc3QgZm9ybWF0ID0gZ2V0TG9jYWxlRGF0ZUZvcm1hdCh0aGlzLl9sb2NhbGUsIEZvcm1hdFdpZHRoLlNob3J0KTtcblx0XHRjb25zdCBncm91cHMgPSBmb3JtYXQuc3BsaXQodGhpcy5fcmVnZXgpO1xuXHRcdGdyb3Vwcy5mb3JFYWNoKChnLCBpKSA9PiB7XG5cdFx0XHRpZiAoZy5pbmRleE9mKCdkJykgIT09IC0xKSB7XG5cdFx0XHRcdHRoaXMuX29yZGVyLmRhdGUgPSBpO1xuXHRcdFx0fVxuXHRcdFx0aWYgKGcuaW5kZXhPZignTScpICE9PSAtMSkge1xuXHRcdFx0XHR0aGlzLl9vcmRlci5tb250aCA9IGk7XG5cdFx0XHR9XG5cdFx0XHRpZiAoZy5pbmRleE9mKCd5JykgIT09IC0xKSB7XG5cdFx0XHRcdHRoaXMuX29yZGVyLnllYXIgPSBpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cdHByaXZhdGUgZXh0cmFjdCh0ZXh0OiBzdHJpbmcsIGdyYW51bGFyaXR5OiBFTHVEYXRlR3JhbnVsYXJpdHkgPSBFTHVEYXRlR3JhbnVsYXJpdHkuZGF5KTogeyBkYXRlOiBudW1iZXI7IG1vbnRoOiBudW1iZXI7IHllYXI6IG51bWJlciB9IHtcblx0XHRjb25zdCBncm91cHMgPSB0ZXh0LnNwbGl0KHRoaXMuX3JlZ2V4KTtcblx0XHRsZXQgZGF0ZSA9IDEsXG5cdFx0XHRtb250aCA9IDEsXG5cdFx0XHR5ZWFyID0gMTtcblx0XHRzd2l0Y2ggKGdyYW51bGFyaXR5KSB7XG5cdFx0XHRjYXNlIEVMdURhdGVHcmFudWxhcml0eS55ZWFyOlxuXHRcdFx0XHR5ZWFyID0gcGFyc2VJbnQoZ3JvdXBzW01hdGgubWF4KHRoaXMuX29yZGVyLnllYXIgLSAyLCAwKV0sIDEwKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIEVMdURhdGVHcmFudWxhcml0eS5tb250aDpcblx0XHRcdFx0bW9udGggPSBwYXJzZUludChncm91cHNbTWF0aC5tYXgodGhpcy5fb3JkZXIubW9udGggLSAxLCAwKV0sIDEwKTtcblx0XHRcdFx0eWVhciA9IHBhcnNlSW50KGdyb3Vwc1tNYXRoLm1heCh0aGlzLl9vcmRlci55ZWFyIC0gMSwgMCldLCAxMCkgfHwgbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgRUx1RGF0ZUdyYW51bGFyaXR5LmRheTpcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdGRhdGUgPSBwYXJzZUludChncm91cHNbdGhpcy5fb3JkZXIuZGF0ZV0sIDEwKTtcblx0XHRcdFx0bW9udGggPSBwYXJzZUludChncm91cHNbdGhpcy5fb3JkZXIubW9udGhdLCAxMCk7XG5cdFx0XHRcdHllYXIgPSBwYXJzZUludChncm91cHNbdGhpcy5fb3JkZXIueWVhcl0sIDEwKSB8fCBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7XG5cdFx0fVxuXHRcdHJldHVybiB7IGRhdGUsIG1vbnRoLCB5ZWFyIH07XG5cdH1cblx0aXNQYXJzYWJsZSh0ZXh0OiBzdHJpbmcsIGdyYW51bGFyaXR5ID0gRUx1RGF0ZUdyYW51bGFyaXR5LmRheSk6IGJvb2xlYW4ge1xuXHRcdGlmICghdGV4dCkge1xuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0XHRjb25zdCBncm91cHMgPSB0ZXh0LnNwbGl0KHRoaXMuX3JlZ2V4KTtcblx0XHRjb25zdCBkYXlUZXh0SW52YWxpZCA9IGdyYW51bGFyaXR5ID09PSBFTHVEYXRlR3JhbnVsYXJpdHkuZGF5ICYmIGdyb3Vwcy5sZW5ndGggIT09IDM7XG5cdFx0Y29uc3QgbW9udGhUZXh0SW52YWxpZCA9IGdyYW51bGFyaXR5ID09PSBFTHVEYXRlR3JhbnVsYXJpdHkubW9udGggJiYgZ3JvdXBzLmxlbmd0aCAhPT0gMjtcblx0XHRjb25zdCB5ZWFyVGV4dEludmFsaWQgPSBncmFudWxhcml0eSA9PT0gRUx1RGF0ZUdyYW51bGFyaXR5LnllYXIgJiYgZ3JvdXBzLmxlbmd0aCAhPT0gMTtcblx0XHRpZiAoZGF5VGV4dEludmFsaWQgfHwgbW9udGhUZXh0SW52YWxpZCB8fCB5ZWFyVGV4dEludmFsaWQpIHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cblx0XHR0cnkge1xuXHRcdFx0Y29uc3QgeyBkYXRlLCBtb250aCwgeWVhciB9ID0gdGhpcy5leHRyYWN0KHRleHQsIGdyYW51bGFyaXR5KTtcblxuXHRcdFx0Ly8gV2hlbiB5ZWFyIGlzIGVxdWFsIG9yIGdyZWF0ZXIgdGhhbiAxMF8wMDAgSVNPIHN0cmluZyBnb2VzIGZyb20gMjAwMC0wMS0wMSB0byArMDEwMDAwLTAxLTAxIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQgYnkgYmFja2VuZHNcblx0XHRcdGlmICh5ZWFyID49IDEwXzAwMCkge1xuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBkOiBEYXRlO1xuXHRcdFx0aWYgKHRoaXMuX29wdGlvbnMudXNlVXRjKSB7XG5cdFx0XHRcdGQgPSBuZXcgRGF0ZShEYXRlLlVUQyh5ZWFyLCBtb250aCAtIDEsIGRhdGUpKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGQgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIGRhdGUpO1xuXHRcdFx0fVxuXHRcdFx0Ly8gY2hlY2tpbmcgaWYgaXRzIGEgdmFsaWQgZGF0ZVxuXHRcdFx0Ly8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTM1MzY4NC9kZXRlY3RpbmctYW4taW52YWxpZC1kYXRlLWRhdGUtaW5zdGFuY2UtaW4tamF2YXNjcmlwdFxuXHRcdFx0aWYgKCEoZCBpbnN0YW5jZW9mIERhdGUpKSB7XG5cdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdH1cblx0XHRcdGlmIChpc05hTihkLmdldFRpbWUoKSkpIHtcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0fVxuXHRcdFx0Ly8gZCBpcyBhIHZhbGlkIGRhdGUsIGJ1dFxuXHRcdFx0Ly8gYXMgaSBjYW4gd3JpdGUgbmV3IERhdGUoMTIzNCwgNTYsIDc4KSBhbmQgbXIgamF2YXNjcmlwdCBhY2NlcHRzIGl0XG5cdFx0XHQvLyBpIGNoZWNrIG5vdyB0aGF0IHRoZSBnZW5lcmF0ZWQgZGF0ZSBoYXMgdGhlIHNhbWUgeWVhci9tb250aC9kYXRlIGFzIHdoYXQgaSBlbnRlcmVkXG5cdFx0XHRpZiAodGhpcy5fb3B0aW9ucy51c2VVdGMpIHtcblx0XHRcdFx0aWYgKGQuZ2V0VVRDRnVsbFllYXIoKSAhPT0geWVhcikge1xuXHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoZC5nZXRVVENNb250aCgpICE9PSBtb250aCAtIDEpIHtcblx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGQuZ2V0VVRDRGF0ZSgpICE9PSBkYXRlKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAoZC5nZXRGdWxsWWVhcigpICE9PSB5ZWFyKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChkLmdldE1vbnRoKCkgIT09IG1vbnRoIC0gMSkge1xuXHRcdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHRcdFx0fVxuXHRcdFx0XHRpZiAoZC5nZXREYXRlKCkgIT09IGRhdGUpIHtcblx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fSBjYXRjaCB7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHR9XG5cdHBhcnNlKHRleHQ6IHN0cmluZywgZ3JhbnVsYXJpdHkgPSBFTHVEYXRlR3JhbnVsYXJpdHkuZGF5KTogRGF0ZSB7XG5cdFx0aWYgKCF0ZXh0KSB7XG5cdFx0XHRyZXR1cm4gdW5kZWZpbmVkO1xuXHRcdH1cblxuXHRcdGlmICghdGhpcy5pc1BhcnNhYmxlKHRleHQsIGdyYW51bGFyaXR5KSkge1xuXHRcdFx0cmV0dXJuIHRoaXMuZm9yZ2VJbnZhbGlkKCk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgeyBkYXRlLCBtb250aCwgeWVhciB9ID0gdGhpcy5leHRyYWN0KHRleHQsIGdyYW51bGFyaXR5KTtcblxuXHRcdHJldHVybiB0aGlzLmZvcmdlKHllYXIsIG1vbnRoLCBkYXRlKTtcblx0fVxuXHRmb3JtYXQoZDogRGF0ZSwgZm9ybWF0OiBzdHJpbmcpOiBzdHJpbmcge1xuXHRcdGlmICh0aGlzLl9vcHRpb25zLnVzZVV0Yykge1xuXHRcdFx0cmV0dXJuIGZvcm1hdERhdGUoZCwgZm9ybWF0LCB0aGlzLl9sb2NhbGUsICdVVEMnKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIGZvcm1hdERhdGUoZCwgZm9ybWF0LCB0aGlzLl9sb2NhbGUpO1xuXHRcdH1cblx0fVxuXHRmb3JnZSh5ZWFyOiBudW1iZXIsIG1vbnRoOiBudW1iZXIsIGRhdGU6IG51bWJlcik6IERhdGUge1xuXHRcdGlmICh0aGlzLl9vcHRpb25zLnVzZVV0Yykge1xuXHRcdFx0cmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKHllYXIsIG1vbnRoIC0gMSwgZGF0ZSkpOyAvLyBtb250aC0xIGN1eiAwIC0+IGphbnVhcnlcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgZGF0ZSk7IC8vIG1vbnRoLTEgY3V6IDAgLT4gamFudWFyeVxuXHRcdH1cblx0fVxuXHRmb3JnZVRvZGF5KCk6IERhdGUge1xuXHRcdGlmICh0aGlzLl9vcHRpb25zLnVzZVV0Yykge1xuXHRcdFx0Y29uc3Qgbm9uVVRDVG9kYXkgPSBuZXcgRGF0ZSgpO1xuXHRcdFx0cmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKG5vblVUQ1RvZGF5LmdldEZ1bGxZZWFyKCksIG5vblVUQ1RvZGF5LmdldE1vbnRoKCksIG5vblVUQ1RvZGF5LmdldERhdGUoKSkpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG5cdFx0XHRyZXR1cm4gbmV3IERhdGUodG9kYXkuZ2V0RnVsbFllYXIoKSwgdG9kYXkuZ2V0TW9udGgoKSwgdG9kYXkuZ2V0RGF0ZSgpKTtcblx0XHR9XG5cdH1cblx0Zm9yZ2VJbnZhbGlkKCk6IERhdGUge1xuXHRcdHJldHVybiBuZXcgRGF0ZSgnSW52YWxpZCBEYXRlJyk7XG5cdH1cblx0aXNWYWxpZChkOiBEYXRlKTogYm9vbGVhbiB7XG5cdFx0aWYgKCEoZCBpbnN0YW5jZW9mIERhdGUpKSB7XG5cdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0fVxuXHRcdGlmIChpc05hTihkLmdldFRpbWUoKSkpIHtcblx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHRjbG9uZShkOiBEYXRlKTogRGF0ZSB7XG5cdFx0cmV0dXJuIG5ldyBEYXRlKGQpO1xuXHR9XG5cblx0Z2V0WWVhcihkOiBEYXRlKTogbnVtYmVyIHtcblx0XHRpZiAodGhpcy5fb3B0aW9ucy51c2VVdGMpIHtcblx0XHRcdHJldHVybiBkLmdldFVUQ0Z1bGxZZWFyKCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiBkLmdldEZ1bGxZZWFyKCk7XG5cdFx0fVxuXHR9XG5cdGdldE1vbnRoKGQ6IERhdGUpOiBudW1iZXIge1xuXHRcdGlmICh0aGlzLl9vcHRpb25zLnVzZVV0Yykge1xuXHRcdFx0cmV0dXJuIGQuZ2V0VVRDTW9udGgoKSArIDE7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiBkLmdldE1vbnRoKCkgKyAxO1xuXHRcdH1cblx0fVxuXHRnZXREYXRlKGQ6IERhdGUpOiBudW1iZXIge1xuXHRcdGlmICh0aGlzLl9vcHRpb25zLnVzZVV0Yykge1xuXHRcdFx0cmV0dXJuIGQuZ2V0VVRDRGF0ZSgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gZC5nZXREYXRlKCk7XG5cdFx0fVxuXHR9XG5cdGdldERheShkOiBEYXRlKTogbnVtYmVyIHtcblx0XHRpZiAodGhpcy5fb3B0aW9ucy51c2VVdGMpIHtcblx0XHRcdHJldHVybiBkLmdldFVUQ0RheSgpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gZC5nZXREYXkoKTtcblx0XHR9XG5cdH1cblxuXHRhZGQoZDogRGF0ZSwgY291bnQ6IG51bWJlciwgZ3JhbnVsYXJpdHk6IEVMdURhdGVHcmFudWxhcml0eSk6IERhdGUge1xuXHRcdGxldCB5ZWFyID0gdGhpcy5nZXRZZWFyKGQpO1xuXHRcdGxldCBtb250aCA9IHRoaXMuZ2V0TW9udGgoZCk7XG5cdFx0bGV0IGRhdGUgPSB0aGlzLmdldERhdGUoZCk7XG5cdFx0c3dpdGNoIChncmFudWxhcml0eSkge1xuXHRcdFx0Y2FzZSBFTHVEYXRlR3JhbnVsYXJpdHkuZGVjYWRlOlxuXHRcdFx0XHR5ZWFyICs9IDEwICogY291bnQ7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBFTHVEYXRlR3JhbnVsYXJpdHkueWVhcjpcblx0XHRcdFx0eWVhciArPSBjb3VudDtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIEVMdURhdGVHcmFudWxhcml0eS5tb250aDpcblx0XHRcdFx0bW9udGggKz0gY291bnQ7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBFTHVEYXRlR3JhbnVsYXJpdHkuZGF5OlxuXHRcdFx0XHRkYXRlICs9IGNvdW50O1xuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMuZm9yZ2UoeWVhciwgbW9udGgsIGRhdGUpO1xuXHR9XG59XG4iXX0=