import { OverlayConfig } from '@angular/cdk/overlay';
import { ComponentPortal } from '@angular/cdk/portal';
import { Injector } from '@angular/core';
import { Subject, Subscription } from 'rxjs';
import { filter } from 'rxjs/operators';
import { LU_POPUP_DATA } from './popup.token';
export class ALuPopupRef {
    constructor(_overlay, _injector, _component, _config) {
        this._overlay = _overlay;
        this._injector = _injector;
        this._component = _component;
        this._config = _config;
        this.onOpen = new Subject();
        this.onClose = new Subject();
        this.onDismiss = new Subject();
        this.onBackdropClick = new Subject();
        this._subs = new Subscription();
    }
    open(data) {
        this._createOverlay();
        this._openPopup(data);
        this._subToCloseEvents();
        this.onOpen.next(data);
        this.onOpen.complete();
    }
    close(result) {
        this.onClose.next(result);
        this._destroy();
    }
    dismiss() {
        this.onDismiss.next();
        this._destroy();
    }
    /**
     *  This method creates the overlay from the provided popover's template and saves its
     *  OverlayRef so that it can be attached to the DOM when openPopover is called.
     */
    _createOverlay() {
        if (!this._overlayRef) {
            const overlayConfig = this._getOverlayConfig();
            this._overlayRef = this._overlay.create(overlayConfig);
        }
    }
    /**
     * This method builds the configuration object needed to create the overlay, the OverlayConfig.
     * @returns OverlayConfig
     */
    _getOverlayConfig() {
        const overlayConfig = new OverlayConfig();
        switch (this._config.position) {
            case 'top':
                overlayConfig.positionStrategy = this._overlay.position().global().centerHorizontally().top('0');
                break;
            case 'bottom':
                overlayConfig.positionStrategy = this._overlay.position().global().centerHorizontally().bottom('0');
                break;
            case 'left':
                overlayConfig.positionStrategy = this._overlay.position().global().centerVertically().left('0');
                break;
            case 'right':
                overlayConfig.positionStrategy = this._overlay.position().global().centerVertically().right('0');
                break;
            case 'center':
            default:
                overlayConfig.positionStrategy = this._overlay.position().global().centerHorizontally().centerVertically();
                break;
        }
        overlayConfig.hasBackdrop = !this._config.noBackdrop;
        overlayConfig.backdropClass = this._config.backdropClass;
        overlayConfig.panelClass = this._getOverlayPanelClasses();
        overlayConfig.scrollStrategy = this._overlay.scrollStrategies.block();
        return overlayConfig;
    }
    _openPopup(data) {
        const injector = Injector.create({
            providers: [
                { provide: ALuPopupRef, useValue: this },
                { provide: LU_POPUP_DATA, useValue: data },
            ],
            parent: this._injector,
        });
        const portal = new ComponentPortal(this._component, undefined, injector);
        this._componentRef = this._overlayRef.attach(portal);
    }
    _getOverlayPanelClasses() {
        const panelClasses = [];
        if (Array.isArray(this._config.panelClass)) {
            panelClasses.push(...this._config.panelClass);
        }
        else {
            panelClasses.push(this._config.panelClass);
        }
        panelClasses.push(`mod-${this._config.size}`);
        return panelClasses;
    }
    _destroy() {
        this._cleanSubscription();
        this._closePopup();
        this._destroyOverlay();
        this._completeSubjects();
    }
    _completeSubjects() {
        this.onClose.complete();
        this.onOpen.complete();
        this.onDismiss.complete();
        this.onBackdropClick.complete();
    }
    _destroyOverlay() {
        this._overlayRef.detachBackdrop();
        this._overlayRef.detach();
    }
    _closePopup() {
        this._componentRef.destroy();
    }
    _subToCloseEvents() {
        if (!this._config.undismissable) {
            this._subToEscapeKeydownEvent();
        }
        this._subToBackdropClickEvent();
    }
    _subToEscapeKeydownEvent() {
        const escPressed$ = this._overlayRef.keydownEvents().pipe(filter(({ key }) => key === 'Escape'));
        this._subs.add(escPressed$.subscribe((_e) => this.dismiss()));
    }
    _subToBackdropClickEvent() {
        const bdClicked$ = this._overlayRef.backdropClick();
        const bdClickedSub = bdClicked$.subscribe((_e) => {
            this.onBackdropClick.next();
            if (!this._config.undismissable) {
                this.dismiss();
            }
        });
        this._subs.add(bdClickedSub);
    }
    _cleanSubscription() {
        this._subs.unsubscribe();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wdXAtcmVmLm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGFja2FnZXMvbmcvcG9wdXAvcG9wdXAtcmVmLm1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBVyxhQUFhLEVBQWMsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFpQixNQUFNLHFCQUFxQixDQUFDO0FBQ3JFLE9BQU8sRUFBZ0IsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZELE9BQU8sRUFBYyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBZTlDLE1BQU0sT0FBZ0IsV0FBVztJQVdoQyxZQUFzQixRQUFpQixFQUFZLFNBQW1CLEVBQVksVUFBNEIsRUFBWSxPQUFVO1FBQTlHLGFBQVEsR0FBUixRQUFRLENBQVM7UUFBWSxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQVksZUFBVSxHQUFWLFVBQVUsQ0FBa0I7UUFBWSxZQUFPLEdBQVAsT0FBTyxDQUFHO1FBVnBJLFdBQU0sR0FBRyxJQUFJLE9BQU8sRUFBSyxDQUFDO1FBQzFCLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBSyxDQUFDO1FBQzNCLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ2hDLG9CQUFlLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUs1QixVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztJQUVrRyxDQUFDO0lBRXhJLElBQUksQ0FBQyxJQUFRO1FBQ1osSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdEIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFF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WSxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUNTLGtCQUFrQjtRQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzFCLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE92ZXJsYXksIE92ZXJsYXlDb25maWcsIE92ZXJsYXlSZWYgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIENvbXBvbmVudFR5cGUgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IENvbXBvbmVudFJlZiwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSUx1UG9wdXBDb25maWcgfSBmcm9tICcuL3BvcHVwLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBMVV9QT1BVUF9EQVRBIH0gZnJvbSAnLi9wb3B1cC50b2tlbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUx1UG9wdXBSZWY8RCA9IHVua25vd24sIFIgPSB1bmtub3duPiB7XG5cdG9uT3BlbjogT2JzZXJ2YWJsZTxEPjtcblx0b25DbG9zZTogT2JzZXJ2YWJsZTxSPjtcblx0b25EaXNtaXNzOiBPYnNlcnZhYmxlPHZvaWQ+O1xuXHRvbkJhY2tkcm9wQ2xpY2s6IE9ic2VydmFibGU8dm9pZD47XG5cdG9wZW4oZGF0YTogRCk6IHZvaWQ7XG5cdGNsb3NlKHJlc3VsdDogUik6IHZvaWQ7XG5cdGRpc21pc3MoKTogdm9pZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgSUx1UG9wdXBSZWZGYWN0b3J5PFRDb21wb25lbnQgPSB1bmtub3duLCBUQ29uZmlnIGV4dGVuZHMgSUx1UG9wdXBDb25maWcgPSBJTHVQb3B1cENvbmZpZz4ge1xuXHRmb3JnZTxUIGV4dGVuZHMgVENvbXBvbmVudCwgQyBleHRlbmRzIFRDb25maWcsIEQsIFI+KGNvbXBvbmVudDogQ29tcG9uZW50VHlwZTxUPiwgY29uZmlnOiBDKTogSUx1UG9wdXBSZWY8RCwgUj47XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBTHVQb3B1cFJlZjxUID0gdW5rbm93biwgRCA9IHVua25vd24sIFIgPSB1bmtub3duLCBDIGV4dGVuZHMgSUx1UG9wdXBDb25maWcgPSBJTHVQb3B1cENvbmZpZz4gaW1wbGVtZW50cyBJTHVQb3B1cFJlZjxELCBSPiB7XG5cdG9uT3BlbiA9IG5ldyBTdWJqZWN0PEQ+KCk7XG5cdG9uQ2xvc2UgPSBuZXcgU3ViamVjdDxSPigpO1xuXHRvbkRpc21pc3MgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXHRvbkJhY2tkcm9wQ2xpY2sgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG5cdHByb3RlY3RlZCBfb3ZlcmxheVJlZjogT3ZlcmxheVJlZjtcblx0cHJvdGVjdGVkIF9jb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxUPjtcblxuXHRwcm90ZWN0ZWQgX3N1YnMgPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cblx0Y29uc3RydWN0b3IocHJvdGVjdGVkIF9vdmVybGF5OiBPdmVybGF5LCBwcm90ZWN0ZWQgX2luamVjdG9yOiBJbmplY3RvciwgcHJvdGVjdGVkIF9jb21wb25lbnQ6IENvbXBvbmVudFR5cGU8VD4sIHByb3RlY3RlZCBfY29uZmlnOiBDKSB7fVxuXG5cdG9wZW4oZGF0YT86IEQpIHtcblx0XHR0aGlzLl9jcmVhdGVPdmVybGF5KCk7XG5cdFx0dGhpcy5fb3BlblBvcHVwKGRhdGEpO1xuXG5cdFx0dGhpcy5fc3ViVG9DbG9zZUV2ZW50cygpO1xuXG5cdFx0dGhpcy5vbk9wZW4ubmV4dChkYXRhKTtcblx0XHR0aGlzLm9uT3Blbi5jb21wbGV0ZSgpO1xuXHR9XG5cdGNsb3NlKHJlc3VsdD86IFIpIHtcblx0XHR0aGlzLm9uQ2xvc2UubmV4dChyZXN1bHQpO1xuXHRcdHRoaXMuX2Rlc3Ryb3koKTtcblx0fVxuXHRkaXNtaXNzKCkge1xuXHRcdHRoaXMub25EaXNtaXNzLm5leHQoKTtcblx0XHR0aGlzLl9kZXN0cm95KCk7XG5cdH1cblx0LyoqXG5cdCAqICBUaGlzIG1ldGhvZCBjcmVhdGVzIHRoZSBvdmVybGF5IGZyb20gdGhlIHByb3ZpZGVkIHBvcG92ZXIncyB0ZW1wbGF0ZSBhbmQgc2F2ZXMgaXRzXG5cdCAqICBPdmVybGF5UmVmIHNvIHRoYXQgaXQgY2FuIGJlIGF0dGFjaGVkIHRvIHRoZSBET00gd2hlbiBvcGVuUG9wb3ZlciBpcyBjYWxsZWQuXG5cdCAqL1xuXHRwcm90ZWN0ZWQgX2NyZWF0ZU92ZXJsYXkoKSB7XG5cdFx0aWYgKCF0aGlzLl9vdmVybGF5UmVmKSB7XG5cdFx0XHRjb25zdCBvdmVybGF5Q29uZmlnID0gdGhpcy5fZ2V0T3ZlcmxheUNvbmZpZygpO1xuXHRcdFx0dGhpcy5fb3ZlcmxheVJlZiA9IHRoaXMuX292ZXJsYXkuY3JlYXRlKG92ZXJsYXlDb25maWcpO1xuXHRcdH1cblx0fVxuXHQvKipcblx0ICogVGhpcyBtZXRob2QgYnVpbGRzIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBuZWVkZWQgdG8gY3JlYXRlIHRoZSBvdmVybGF5LCB0aGUgT3ZlcmxheUNvbmZpZy5cblx0ICogQHJldHVybnMgT3ZlcmxheUNvbmZpZ1xuXHQgKi9cblx0cHJvdGVjdGVkIF9nZXRPdmVybGF5Q29uZmlnKCk6IE92ZXJsYXlDb25maWcge1xuXHRcdGNvbnN0IG92ZXJsYXlDb25maWcgPSBuZXcgT3ZlcmxheUNvbmZpZygpO1xuXHRcdHN3aXRjaCAodGhpcy5fY29uZmlnLnBvc2l0aW9uKSB7XG5cdFx0XHRjYXNlICd0b3AnOlxuXHRcdFx0XHRvdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLl9vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCkuY2VudGVySG9yaXpvbnRhbGx5KCkudG9wKCcwJyk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAnYm90dG9tJzpcblx0XHRcdFx0b3ZlcmxheUNvbmZpZy5wb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5fb3ZlcmxheS5wb3NpdGlvbigpLmdsb2JhbCgpLmNlbnRlckhvcml6b250YWxseSgpLmJvdHRvbSgnMCcpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ2xlZnQnOlxuXHRcdFx0XHRvdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3kgPSB0aGlzLl9vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCkuY2VudGVyVmVydGljYWxseSgpLmxlZnQoJzAnKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdyaWdodCc6XG5cdFx0XHRcdG92ZXJsYXlDb25maWcucG9zaXRpb25TdHJhdGVneSA9IHRoaXMuX292ZXJsYXkucG9zaXRpb24oKS5nbG9iYWwoKS5jZW50ZXJWZXJ0aWNhbGx5KCkucmlnaHQoJzAnKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICdjZW50ZXInOlxuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0b3ZlcmxheUNvbmZpZy5wb3NpdGlvblN0cmF0ZWd5ID0gdGhpcy5fb3ZlcmxheS5wb3NpdGlvbigpLmdsb2JhbCgpLmNlbnRlckhvcml6b250YWxseSgpLmNlbnRlclZlcnRpY2FsbHkoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXHRcdG92ZXJsYXlDb25maWcuaGFzQmFja2Ryb3AgPSAhdGhpcy5fY29uZmlnLm5vQmFja2Ryb3A7XG5cdFx0b3ZlcmxheUNvbmZpZy5iYWNrZHJvcENsYXNzID0gdGhpcy5fY29uZmlnLmJhY2tkcm9wQ2xhc3M7XG5cdFx0b3ZlcmxheUNvbmZpZy5wYW5lbENsYXNzID0gdGhpcy5fZ2V0T3ZlcmxheVBhbmVsQ2xhc3NlcygpO1xuXHRcdG92ZXJsYXlDb25maWcuc2Nyb2xsU3RyYXRlZ3kgPSB0aGlzLl9vdmVybGF5LnNjcm9sbFN0cmF0ZWdpZXMuYmxvY2soKTtcblx0XHRyZXR1cm4gb3ZlcmxheUNvbmZpZztcblx0fVxuXHRwcm90ZWN0ZWQgX29wZW5Qb3B1cChkYXRhPzogRCkge1xuXHRcdGNvbnN0IGluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcblx0XHRcdHByb3ZpZGVyczogW1xuXHRcdFx0XHR7IHByb3ZpZGU6IEFMdVBvcHVwUmVmLCB1c2VWYWx1ZTogdGhpcyB9LFxuXHRcdFx0XHR7IHByb3ZpZGU6IExVX1BPUFVQX0RBVEEsIHVzZVZhbHVlOiBkYXRhIH0sXG5cdFx0XHRdLFxuXHRcdFx0cGFyZW50OiB0aGlzLl9pbmplY3Rvcixcblx0XHR9KTtcblx0XHRjb25zdCBwb3J0YWwgPSBuZXcgQ29tcG9uZW50UG9ydGFsKHRoaXMuX2NvbXBvbmVudCwgdW5kZWZpbmVkLCBpbmplY3Rvcik7XG5cdFx0dGhpcy5fY29tcG9uZW50UmVmID0gdGhpcy5fb3ZlcmxheVJlZi5hdHRhY2g8VD4ocG9ydGFsKTtcblx0fVxuXHRwcm90ZWN0ZWQgX2dldE92ZXJsYXlQYW5lbENsYXNzZXMoKTogc3RyaW5nW10ge1xuXHRcdGNvbnN0IHBhbmVsQ2xhc3Nlczogc3RyaW5nW10gPSBbXTtcblx0XHRpZiAoQXJyYXkuaXNBcnJheSh0aGlzLl9jb25maWcucGFuZWxDbGFzcykpIHtcblx0XHRcdHBhbmVsQ2xhc3Nlcy5wdXNoKC4uLnRoaXMuX2NvbmZpZy5wYW5lbENsYXNzKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cGFuZWxDbGFzc2VzLnB1c2godGhpcy5fY29uZmlnLnBhbmVsQ2xhc3MpO1xuXHRcdH1cblx0XHRwYW5lbENsYXNzZXMucHVzaChgbW9kLSR7dGhpcy5fY29uZmlnLnNpemV9YCk7XG5cdFx0cmV0dXJuIHBhbmVsQ2xhc3Nlcztcblx0fVxuXHRwcm90ZWN0ZWQgX2Rlc3Ryb3koKSB7XG5cdFx0dGhpcy5fY2xlYW5TdWJzY3JpcHRpb24oKTtcblx0XHR0aGlzLl9jbG9zZVBvcHVwKCk7XG5cdFx0dGhpcy5fZGVzdHJveU92ZXJsYXkoKTtcblx0XHR0aGlzLl9jb21wbGV0ZVN1YmplY3RzKCk7XG5cdH1cblx0cHJvdGVjdGVkIF9jb21wbGV0ZVN1YmplY3RzKCkge1xuXHRcdHRoaXMub25DbG9zZS5jb21wbGV0ZSgpO1xuXHRcdHRoaXMub25PcGVuLmNvbXBsZXRlKCk7XG5cdFx0dGhpcy5vbkRpc21pc3MuY29tcGxldGUoKTtcblx0XHR0aGlzLm9uQmFja2Ryb3BDbGljay5jb21wbGV0ZSgpO1xuXHR9XG5cdHByb3RlY3RlZCBfZGVzdHJveU92ZXJsYXkoKSB7XG5cdFx0dGhpcy5fb3ZlcmxheVJlZi5kZXRhY2hCYWNrZHJvcCgpO1xuXHRcdHRoaXMuX292ZXJsYXlSZWYuZGV0YWNoKCk7XG5cdH1cblx0cHJvdGVjdGVkIF9jbG9zZVBvcHVwKCkge1xuXHRcdHRoaXMuX2NvbXBvbmVudFJlZi5kZXN0cm95KCk7XG5cdH1cblx0cHJvdGVjdGVkIF9zdWJUb0Nsb3NlRXZlbnRzKCkge1xuXHRcdGlmICghdGhpcy5fY29uZmlnLnVuZGlzbWlzc2FibGUpIHtcblx0XHRcdHRoaXMuX3N1YlRvRXNjYXBlS2V5ZG93bkV2ZW50KCk7XG5cdFx0fVxuXHRcdHRoaXMuX3N1YlRvQmFja2Ryb3BDbGlja0V2ZW50KCk7XG5cdH1cblx0cHJvdGVjdGVkIF9zdWJUb0VzY2FwZUtleWRvd25FdmVudCgpIHtcblx0XHRjb25zdCBlc2NQcmVzc2VkJCA9IHRoaXMuX292ZXJsYXlSZWYua2V5ZG93bkV2ZW50cygpLnBpcGUoZmlsdGVyKCh7IGtleSB9KSA9PiBrZXkgPT09ICdFc2NhcGUnKSk7XG5cdFx0dGhpcy5fc3Vicy5hZGQoZXNjUHJlc3NlZCQuc3Vic2NyaWJlKChfZSkgPT4gdGhpcy5kaXNtaXNzKCkpKTtcblx0fVxuXHRwcm90ZWN0ZWQgX3N1YlRvQmFja2Ryb3BDbGlja0V2ZW50KCkge1xuXHRcdGNvbnN0IGJkQ2xpY2tlZCQgPSB0aGlzLl9vdmVybGF5UmVmLmJhY2tkcm9wQ2xpY2soKTtcblx0XHRjb25zdCBiZENsaWNrZWRTdWIgPSBiZENsaWNrZWQkLnN1YnNjcmliZSgoX2UpID0+IHtcblx0XHRcdHRoaXMub25CYWNrZHJvcENsaWNrLm5leHQoKTtcblx0XHRcdGlmICghdGhpcy5fY29uZmlnLnVuZGlzbWlzc2FibGUpIHtcblx0XHRcdFx0dGhpcy5kaXNtaXNzKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdFx0dGhpcy5fc3Vicy5hZGQoYmRDbGlja2VkU3ViKTtcblx0fVxuXHRwcm90ZWN0ZWQgX2NsZWFuU3Vic2NyaXB0aW9uKCkge1xuXHRcdHRoaXMuX3N1YnMudW5zdWJzY3JpYmUoKTtcblx0fVxufVxuIl19