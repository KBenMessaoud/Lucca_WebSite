import { ALuPopoverTrigger, LuPopoverTarget } from '@lucca-front/ng/popover';
import { Subscription } from 'rxjs';
export class ALuSelectInput extends ALuPopoverTrigger {
    constructor(_changeDetectorRef, _overlay, _elementRef, _viewContainerRef, _renderer) {
        super(_overlay, _elementRef, _viewContainerRef);
        this._changeDetectorRef = _changeDetectorRef;
        this._overlay = _overlay;
        this._elementRef = _elementRef;
        this._viewContainerRef = _viewContainerRef;
        this._renderer = _renderer;
        this._subs = new Subscription();
        this._isContentInitialized = false;
        // From ControlValueAccessor interface
        this._cvaOnChange = (v) => void v;
        // From ControlValueAccessor interface
        this._onTouched = () => void {};
        // multiple
        this._multiple = false;
        this.target = new LuPopoverTarget();
        this.target.elementRef = this._elementRef;
        this.target.position = 'below';
        this.target.alignment = 'left';
    }
    get placeholder() {
        return this._placeholder;
    }
    set placeholder(p) {
        this._placeholder = p;
    }
    setValue(value) {
        if (this.disabled) {
            return;
        }
        this.value = value;
        this._cvaOnChange(value);
        this._onTouched();
    }
    get value() {
        return this._value;
    }
    set value(value) {
        this._value = value;
        this.render();
        this.applyClasses();
        if (this._picker) {
            this._picker.setValue(value);
        }
        this._changeDetectorRef.markForCheck();
    }
    // From ControlValueAccessor interface
    writeValue(value) {
        this.value = value;
    }
    registerOnChange(fn) {
        this._cvaOnChange = fn;
    }
    registerOnTouched(fn) {
        this._onTouched = fn;
    }
    set disabled(d) {
        this._disabled = d;
    }
    get disabled() {
        return this._disabled;
    }
    setDisabledState(disabled) {
        this.disabled = disabled;
        this._changeDetectorRef.markForCheck();
    }
    isEmpty() {
        const isEmptyArray = Array.isArray(this.value) && this.value.length === 0;
        return this.value === null || this.value === undefined || isEmptyArray;
    }
    applyClasses() {
        if (this.isEmpty()) {
            this._renderer.removeClass(this._elementRef.nativeElement, 'is-filled');
        }
        else {
            this._renderer.addClass(this._elementRef.nativeElement, 'is-filled');
        }
    }
    /**
     * popover trigger class extension
     */
    set _picker(picker) {
        this.panel = picker;
        picker.multiple = this._multiple;
        this.subToPickerEvts();
    }
    get _picker() {
        return this.panel;
    }
    set _clearer(clearer) {
        if (!!clearer && !!clearer.onClear) {
            this._subs.add(clearer.onClear.subscribe(() => this.setValue(this._multiple ? [] : undefined)));
        }
    }
    subToPickerEvts() {
        if (this.panel) {
            this._subs.add(this.panel.onSelectValue.subscribe((value) => this.setValue(value)));
        }
    }
    closePopover() {
        this._onTouched();
        super.closePopover();
    }
    onDestroy() {
        if (this._popoverOpen) {
            this.closePopover();
        }
        this.destroyPopover();
        this._subs.unsubscribe();
        this._cleanUpSubscriptions();
    }
    _getOverlayConfig() {
        const config = super._getOverlayConfig();
        const clientRect = this._elementRef.nativeElement.getBoundingClientRect();
        config.minWidth = `${Math.max(185, clientRect.width)}px`; // might become min/maxWidth
        return config;
    }
    set displayer(d) {
        this._displayer = d;
        this.render();
    }
    set displayContainer(vcr) {
        this._displayContainer = vcr;
    }
    render() {
        if (!this._displayer || !this._isContentInitialized) {
            return;
        }
        if (this.useMultipleViews()) {
            this.renderMultipleViews();
        }
        else {
            this.renderSingleView();
        }
    }
    useMultipleViews() {
        return this._multiple && !!this._displayer && !this._displayer.multiple;
    }
    renderSingleView() {
        this.clearDisplay();
        if (this.value !== null && this.value !== undefined) {
            const newView = this.getView(this.value);
            this.displayView(newView);
        }
    }
    clearDisplay() {
        this._displayContainer.clear();
    }
    getView(value) {
        if (this._displayer) {
            return this._displayer.getViewRef(value);
        }
        return undefined;
    }
    displayView(view) {
        if (view) {
            this._displayContainer.insert(view);
        }
    }
    renderMultipleViews() {
        this.clearDisplay();
        const values = this.value || [];
        const views = values.map((value) => this.getView(value));
        views.forEach((view) => this.displayView(view));
    }
    set multiple(m) {
        this._multiple = m;
        if (this._picker) {
            this._picker.multiple = m;
        }
    }
    get multiple() {
        return this._multiple;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LWlucHV0Lm1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvbmcvc2VsZWN0L2lucHV0L3NlbGVjdC1pbnB1dC5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVwQyxNQUFNLE9BQWdCLGNBQXlFLFNBQVEsaUJBQTBCO0lBRWhJLFlBQ1csa0JBQXFDLEVBQzVCLFFBQWlCLEVBQ2pCLFdBQW9DLEVBQ3BDLGlCQUFtQyxFQUM1QyxTQUFvQjtRQUU5QixLQUFLLENBQUMsUUFBUSxFQUFFLFdBQVcsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBTnRDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBbUI7UUFDNUIsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQixnQkFBVyxHQUFYLFdBQVcsQ0FBeUI7UUFDcEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFrQjtRQUM1QyxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBTnJCLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBYzNCLDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQW9DeEMsc0NBQXNDO1FBQzVCLGlCQUFZLEdBQUcsQ0FBQyxDQUFVLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBSWhELHNDQUFzQztRQUM1QixlQUFVLEdBQUcsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUF3SHJDLFdBQVc7UUFDRCxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBeEszQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUMxQyxJQUFJLENB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IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgVmlld0NvbnRhaW5lclJlZiwgVmlld1JlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBJTHVDbGVhcmVyLCBJTHVJbnB1dCwgSUx1SW5wdXREaXNwbGF5ZXIgfSBmcm9tICdAbHVjY2EtZnJvbnQvbmcvaW5wdXQnO1xuaW1wb3J0IHsgSUx1SW5wdXRXaXRoUGlja2VyLCBJTHVQaWNrZXJQYW5lbCB9IGZyb20gJ0BsdWNjYS1mcm9udC9uZy9waWNrZXInO1xuaW1wb3J0IHsgQUx1UG9wb3ZlclRyaWdnZXIsIEx1UG9wb3ZlclRhcmdldCB9IGZyb20gJ0BsdWNjYS1mcm9udC9uZy9wb3BvdmVyJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQUx1U2VsZWN0SW5wdXQ8VCwgVFBpY2tlciBleHRlbmRzIElMdVBpY2tlclBhbmVsPFQ+ID0gSUx1UGlja2VyUGFuZWw8VD4+IGV4dGVuZHMgQUx1UG9wb3ZlclRyaWdnZXI8VFBpY2tlcj4gaW1wbGVtZW50cyBDb250cm9sVmFsdWVBY2Nlc3NvciwgSUx1SW5wdXRXaXRoUGlja2VyPFQ+LCBJTHVJbnB1dCB7XG5cdHByb3RlY3RlZCBfc3VicyA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblx0Y29uc3RydWN0b3IoXG5cdFx0cHJvdGVjdGVkIF9jaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG5cdFx0cHJvdGVjdGVkIG92ZXJyaWRlIF9vdmVybGF5OiBPdmVybGF5LFxuXHRcdHByb3RlY3RlZCBvdmVycmlkZSBfZWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG5cdFx0cHJvdGVjdGVkIG92ZXJyaWRlIF92aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLFxuXHRcdHByb3RlY3RlZCBfcmVuZGVyZXI6IFJlbmRlcmVyMixcblx0KSB7XG5cdFx0c3VwZXIoX292ZXJsYXksIF9lbGVtZW50UmVmLCBfdmlld0NvbnRhaW5lclJlZik7XG5cdFx0dGhpcy50YXJnZXQgPSBuZXcgTHVQb3BvdmVyVGFyZ2V0KCk7XG5cdFx0dGhpcy50YXJnZXQuZWxlbWVudFJlZiA9IHRoaXMuX2VsZW1lbnRSZWY7XG5cdFx0dGhpcy50YXJnZXQucG9zaXRpb24gPSAnYmVsb3cnO1xuXHRcdHRoaXMudGFyZ2V0LmFsaWdubWVudCA9ICdsZWZ0Jztcblx0fVxuXHRwcm90ZWN0ZWQgX2lzQ29udGVudEluaXRpYWxpemVkID0gZmFsc2U7XG5cdHByb3RlY3RlZCBfcGxhY2Vob2xkZXI6IHN0cmluZztcblx0Z2V0IHBsYWNlaG9sZGVyKCkge1xuXHRcdHJldHVybiB0aGlzLl9wbGFjZWhvbGRlcjtcblx0fVxuXHRzZXQgcGxhY2Vob2xkZXIocDogc3RyaW5nKSB7XG5cdFx0dGhpcy5fcGxhY2Vob2xkZXIgPSBwO1xuXHR9XG5cdC8qKlxuXHQgKiBjb250cmlvbCB2YWx1ZSBhY2Nlc3NvciBpbnRlcmZhY2UgaW1wbGVtZW50YXRpb25cblx0ICovXG5cdHByb3RlY3RlZCBfdmFsdWU6IFQgfCBUW107XG5cdHNldFZhbHVlKHZhbHVlOiBUIHwgVFtdKSB7XG5cdFx0aWYgKHRoaXMuZGlzYWJsZWQpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0dGhpcy52YWx1ZSA9IHZhbHVlO1xuXHRcdHRoaXMuX2N2YU9uQ2hhbmdlKHZhbHVlKTtcblx0XHR0aGlzLl9vblRvdWNoZWQoKTtcblx0fVxuXHRnZXQgdmFsdWUoKTogVCB8IFRbXSB7XG5cdFx0cmV0dXJuIHRoaXMuX3ZhbHVlO1xuXHR9XG5cdHNldCB2YWx1ZSh2YWx1ZTogVCB8IFRbXSkge1xuXHRcdHRoaXMuX3ZhbHVlID0gdmFsdWU7XG5cdFx0dGhpcy5yZW5kZXIoKTtcblx0XHR0aGlzLmFwcGx5Q2xhc3NlcygpO1xuXHRcdGlmICh0aGlzLl9waWNrZXIpIHtcblx0XHRcdHRoaXMuX3BpY2tlci5zZXRWYWx1ZSh2YWx1ZSk7XG5cdFx0fVxuXHRcdHRoaXMuX2NoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuXHR9XG5cdC8vIEZyb20gQ29udHJvbFZhbHVlQWNjZXNzb3IgaW50ZXJmYWNlXG5cdHdyaXRlVmFsdWUodmFsdWU6IFQgfCBUW10pIHtcblx0XHR0aGlzLnZhbHVlID0gdmFsdWU7XG5cdH1cblx0Ly8gRnJvbSBDb250cm9sVmFsdWVBY2Nlc3NvciBpbnRlcmZhY2Vcblx0cHJvdGVjdGVkIF9jdmFPbkNoYW5nZSA9ICh2OiBUIHwgVFtdKSA9PiB2b2lkIHY7XG5cdHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2OiBUIHwgVFtdKSA9PiB1bmtub3duKSB7XG5cdFx0dGhpcy5fY3ZhT25DaGFuZ2UgPSBmbjtcblx0fVxuXHQvLyBGcm9tIENvbnRyb2xWYWx1ZUFjY2Vzc29yIGludGVyZmFjZVxuXHRwcm90ZWN0ZWQgX29uVG91Y2hlZCA9ICgpID0+IHZvaWQge307XG5cdHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiB1bmtub3duKSB7XG5cdFx0dGhpcy5fb25Ub3VjaGVkID0gZm47XG5cdH1cblx0b3ZlcnJpZGUgc2V0IGRpc2FibGVkKGQpIHtcblx0XHR0aGlzLl9kaXNhYmxlZCA9IGQ7XG5cdH1cblx0b3ZlcnJpZGUgZ2V0IGRpc2FibGVkKCkge1xuXHRcdHJldHVybiB0aGlzLl9kaXNhYmxlZDtcblx0fVxuXHRzZXREaXNhYmxlZFN0YXRlKGRpc2FibGVkOiBib29sZWFuKSB7XG5cdFx0dGhpcy5kaXNhYmxlZCA9IGRpc2FibGVkO1xuXHRcdHRoaXMuX2NoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuXHR9XG5cdHByb3RlY3RlZCBpc0VtcHR5KCkge1xuXHRcdGNvbnN0IGlzRW1wdHlBcnJheSA9IEFycmF5LmlzQXJyYXkodGhpcy52YWx1ZSkgJiYgdGhpcy52YWx1ZS5sZW5ndGggPT09IDA7XG5cdFx0cmV0dXJuIHRoaXMudmFsdWUgPT09IG51bGwgfHwgdGhpcy52YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IGlzRW1wdHlBcnJheTtcblx0fVxuXHRwcm90ZWN0ZWQgYXBwbHlDbGFzc2VzKCkge1xuXHRcdGlmICh0aGlzLmlzRW1wdHkoKSkge1xuXHRcdFx0dGhpcy5fcmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnaXMtZmlsbGVkJyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHRoaXMuX3JlbmRlcmVyLmFkZENsYXNzKHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2lzLWZpbGxlZCcpO1xuXHRcdH1cblx0fVxuXHQvKipcblx0ICogcG9wb3ZlciB0cmlnZ2VyIGNsYXNzIGV4dGVuc2lvblxuXHQgKi9cblx0cHJvdGVjdGVkIHNldCBfcGlja2VyKHBpY2tlcjogVFBpY2tlcikge1xuXHRcdHRoaXMucGFuZWwgPSBwaWNrZXI7XG5cdFx0cGlja2VyLm11bHRpcGxlID0gdGhpcy5fbXVsdGlwbGU7XG5cdFx0dGhpcy5zdWJUb1BpY2tlckV2dHMoKTtcblx0fVxuXHRwcm90ZWN0ZWQgZ2V0IF9waWNrZXIoKSB7XG5cdFx0cmV0dXJuIHRoaXMucGFuZWw7XG5cdH1cblx0cHJvdGVjdGVkIHNldCBfY2xlYXJlcihjbGVhcmVyOiBJTHVDbGVhcmVyPFQ+KSB7XG5cdFx0aWYgKCEhY2xlYXJlciAmJiAhIWNsZWFyZXIub25DbGVhcikge1xuXHRcdFx0dGhpcy5fc3Vicy5hZGQoY2xlYXJlci5vbkNsZWFyLnN1YnNjcmliZSgoKSA9PiB0aGlzLnNldFZhbHVlKHRoaXMuX211bHRpcGxlID8gW10gOiB1bmRlZmluZWQpKSk7XG5cdFx0fVxuXHR9XG5cdHByb3RlY3RlZCBzdWJUb1BpY2tlckV2dHMoKSB7XG5cdFx0aWYgKHRoaXMucGFuZWwpIHtcblx0XHRcdHRoaXMuX3N1YnMuYWRkKHRoaXMucGFuZWwub25TZWxlY3RWYWx1ZS5zdWJzY3JpYmUoKHZhbHVlKSA9PiB0aGlzLnNldFZhbHVlKHZhbHVlKSkpO1xuXHRcdH1cblx0fVxuXG5cdG92ZXJyaWRlIGNsb3NlUG9wb3ZlcigpIHtcblx0XHR0aGlzLl9vblRvdWNoZWQoKTtcblx0XHRzdXBlci5jbG9zZVBvcG92ZXIoKTtcblx0fVxuXG5cdG9uRGVzdHJveSgpIHtcblx0XHRpZiAodGhpcy5fcG9wb3Zlck9wZW4pIHtcblx0XHRcdHRoaXMuY2xvc2VQb3BvdmVyKCk7XG5cdFx0fVxuXHRcdHRoaXMuZGVzdHJveVBvcG92ZXIoKTtcblx0XHR0aGlzLl9zdWJzLnVuc3Vic2NyaWJlKCk7XG5cdFx0dGhpcy5fY2xlYW5VcFN1YnNjcmlwdGlvbnMoKTtcblx0fVxuXG5cdHByb3RlY3RlZCBvdmVycmlkZSBfZ2V0T3ZlcmxheUNvbmZpZygpOiBPdmVybGF5Q29uZmlnIHtcblx0XHRjb25zdCBjb25maWcgPSBzdXBlci5fZ2V0T3ZlcmxheUNvbmZpZygpO1xuXHRcdGNvbnN0IGNsaWVudFJlY3QgPSB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cdFx0Y29uZmlnLm1pbldpZHRoID0gYCR7TWF0aC5tYXgoMTg1LCBjbGllbnRSZWN0LndpZHRoKX1weGA7IC8vIG1pZ2h0IGJlY29tZSBtaW4vbWF4V2lkdGhcblx0XHRyZXR1cm4gY29uZmlnO1xuXHR9XG5cblx0LyogUmVuZGVyaW5nIHZpYSBhIGlucHQgZGlzcGxheWVyICovXG5cdHByb3RlY3RlZCBfZGlzcGxheWVyOiBJTHVJbnB1dERpc3BsYXllcjxUPjtcblx0cHJvdGVjdGVkIF9kaXNwbGF5Q29udGFpbmVyOiBWaWV3Q29udGFpbmVyUmVmO1xuXHRwcm90ZWN0ZWQgc2V0IGRpc3BsYXllcihkOiBJTHVJbnB1dERpc3BsYXllcjxUPikge1xuXHRcdHRoaXMuX2Rpc3BsYXllciA9IGQ7XG5cdFx0dGhpcy5yZW5kZXIoKTtcblx0fVxuXHRwcm90ZWN0ZWQgc2V0IGRpc3BsYXlDb250YWluZXIodmNyOiBWaWV3Q29udGFpbmVyUmVmKSB7XG5cdFx0dGhpcy5fZGlzcGxheUNvbnRhaW5lciA9IHZjcjtcblx0fVxuXHRwcm90ZWN0ZWQgcmVuZGVyKCkge1xuXHRcdGlmICghdGhpcy5fZGlzcGxheWVyIHx8ICF0aGlzLl9pc0NvbnRlbnRJbml0aWFsaXplZCkge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRpZiAodGhpcy51c2VNdWx0aXBsZVZpZXdzKCkpIHtcblx0XHRcdHRoaXMucmVuZGVyTXVsdGlwbGVWaWV3cygpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR0aGlzLnJlbmRlclNpbmdsZVZpZXcoKTtcblx0XHR9XG5cdH1cblx0cHJvdGVjdGVkIHVzZU11bHRpcGxlVmlld3MoKSB7XG5cdFx0cmV0dXJuIHRoaXMuX211bHRpcGxlICYmICEhdGhpcy5fZGlzcGxheWVyICYmICF0aGlzLl9kaXNwbGF5ZXIubXVsdGlwbGU7XG5cdH1cblxuXHRwcm90ZWN0ZWQgcmVuZGVyU2luZ2xlVmlldygpIHtcblx0XHR0aGlzLmNsZWFyRGlzcGxheSgpO1xuXHRcdGlmICh0aGlzLnZhbHVlICE9PSBudWxsICYmIHRoaXMudmFsdWUgIT09IHVuZGVmaW5lZCkge1xuXHRcdFx0Y29uc3QgbmV3VmlldyA9IHRoaXMuZ2V0Vmlldyh0aGlzLnZhbHVlKTtcblx0XHRcdHRoaXMuZGlzcGxheVZpZXcobmV3Vmlldyk7XG5cdFx0fVxuXHR9XG5cdHByb3RlY3RlZCBjbGVhckRpc3BsYXkoKSB7XG5cdFx0dGhpcy5fZGlzcGxheUNvbnRhaW5lci5jbGVhcigpO1xuXHR9XG5cdHByb3RlY3RlZCBnZXRWaWV3KHZhbHVlOiBUIHwgVFtdKSB7XG5cdFx0aWYgKHRoaXMuX2Rpc3BsYXllcikge1xuXHRcdFx0cmV0dXJuIHRoaXMuX2Rpc3BsYXllci5nZXRWaWV3UmVmKHZhbHVlKTtcblx0XHR9XG5cdFx0cmV0dXJuIHVuZGVmaW5lZDtcblx0fVxuXHRwcm90ZWN0ZWQgZGlzcGxheVZpZXcodmlldzogVmlld1JlZikge1xuXHRcdGlmICh2aWV3KSB7XG5cdFx0XHR0aGlzLl9kaXNwbGF5Q29udGFpbmVyLmluc2VydCh2aWV3KTtcblx0XHR9XG5cdH1cblxuXHRwcm90ZWN0ZWQgcmVuZGVyTXVsdGlwbGVWaWV3cygpIHtcblx0XHR0aGlzLmNsZWFyRGlzcGxheSgpO1xuXHRcdGNvbnN0IHZhbHVlcyA9IDxUW10+dGhpcy52YWx1ZSB8fCBbXTtcblx0XHRjb25zdCB2aWV3cyA9IHZhbHVlcy5tYXAoKHZhbHVlKSA9PiB0aGlzLmdldFZpZXcodmFsdWUpKTtcblx0XHR2aWV3cy5mb3JFYWNoKCh2aWV3KSA9PiB0aGlzLmRpc3BsYXlWaWV3KHZpZXcpKTtcblx0fVxuXHQvLyBtdWx0aXBsZVxuXHRwcm90ZWN0ZWQgX211bHRpcGxlID0gZmFsc2U7XG5cdHNldCBtdWx0aXBsZShtOiBib29sZWFuKSB7XG5cdFx0dGhpcy5fbXVsdGlwbGUgPSBtO1xuXHRcdGlmICh0aGlzLl9waWNrZXIpIHtcblx0XHRcdHRoaXMuX3BpY2tlci5tdWx0aXBsZSA9IG07XG5cdFx0fVxuXHR9XG5cdGdldCBtdWx0aXBsZSgpIHtcblx0XHRyZXR1cm4gdGhpcy5fbXVsdGlwbGU7XG5cdH1cbn1cbiJdfQ==